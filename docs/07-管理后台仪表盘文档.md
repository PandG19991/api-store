# 管理后台仪表盘 API 文档

## 概述

仪表盘 API 提供丰富的统计数据和分析功能,帮助管理员快速了解业务状况、监控关键指标、识别潜在问题。

---

## 功能特性

### 核心统计
- ✅ 销售总额和订单数统计
- ✅ 今日销售数据
- ✅ 订单状态分布
- ✅ 产品库存统计

### 数据分析
- ✅ 销售趋势图表（按天）
- ✅ 热销产品排行榜
- ✅ 收入分布（按货币）
- ✅ 支付方式统计

### 预警监控
- ✅ 低库存产品预警
- ✅ 产品库存详情
- ✅ 最近订单监控

---

## 权限要求

所有仪表盘 API 都需要管理员身份认证：

```
Authorization: Bearer <admin-jwt-token>
```

使用 `authenticate` 中间件进行验证。

---

## API 接口

### 1. 获取仪表盘概览

**端点**: `GET /api/admin/dashboard/overview`

**权限**: 需要管理员认证

**请求头**:
```
Authorization: Bearer <token>
```

**响应示例**:
```json
{
  "success": true,
  "data": {
    "totalRevenue": {
      "amount": 125600.50,
      "count": 342
    },
    "orderStats": {
      "total": 500,
      "pending": 25,
      "paid": 30,
      "completed": 400,
      "cancelled": 40,
      "expired": 5
    },
    "productStats": {
      "total": 15,
      "active": 12,
      "inactive": 3
    },
    "todayRevenue": {
      "amount": 3250.00,
      "count": 8
    },
    "recentOrders": 45
  }
}
```

**字段说明**:
- `totalRevenue.amount`: 总销售额（已完成订单）
- `totalRevenue.count`: 已完成订单总数
- `orderStats`: 各状态订单数量统计
- `productStats`: 产品启用/禁用统计
- `todayRevenue`: 今日销售数据
- `recentOrders`: 最近7天订单数量

---

### 2. 获取最近订单列表

**端点**: `GET /api/admin/dashboard/recent-orders`

**权限**: 需要管理员认证

**查询参数**:
- `limit` (可选): 返回数量，默认 10，最大 100

**请求示例**:
```
GET /api/admin/dashboard/recent-orders?limit=20
```

**响应示例**:
```json
{
  "success": true,
  "data": {
    "orders": [
      {
        "id": 123,
        "orderNumber": "ORD-20251016-ABC123",
        "email": "customer@example.com",
        "totalAmount": 299.99,
        "currency": "CNY",
        "status": "completed",
        "paymentMethod": "alipay",
        "createdAt": "2025-10-16T10:30:00.000Z",
        "items": [
          {
            "productName": "Windows 11 Pro",
            "quantity": 1,
            "price": 299.99
          }
        ]
      }
    ],
    "total": 20
  }
}
```

---

### 3. 获取热销产品排行

**端点**: `GET /api/admin/dashboard/top-products`

**权限**: 需要管理员认证

**查询参数**:
- `limit` (可选): 返回数量，默认 10，最大 50

**请求示例**:
```
GET /api/admin/dashboard/top-products?limit=5
```

**响应示例**:
```json
{
  "success": true,
  "data": {
    "products": [
      {
        "id": 1,
        "name": "Windows 11 Pro",
        "slug": "windows-11-pro",
        "orderCount": 156,
        "totalSold": 180,
        "totalRevenue": 53820.00
      },
      {
        "id": 2,
        "name": "Office 2021 Professional",
        "slug": "office-2021-pro",
        "orderCount": 98,
        "totalSold": 120,
        "totalRevenue": 35940.00
      }
    ],
    "total": 5
  }
}
```

**字段说明**:
- `orderCount`: 包含该产品的订单数量
- `totalSold`: 总销售数量
- `totalRevenue`: 该产品总收入

---

### 4. 获取销售趋势

**端点**: `GET /api/admin/dashboard/sales-trend`

**权限**: 需要管理员认证

**查询参数**:
- `days` (可选): 统计天数，默认 30，最大 365

**请求示例**:
```
GET /api/admin/dashboard/sales-trend?days=7
```

**响应示例**:
```json
{
  "success": true,
  "data": {
    "trend": [
      {
        "date": "2025-10-10",
        "orderCount": 12,
        "revenue": 3589.88
      },
      {
        "date": "2025-10-11",
        "orderCount": 15,
        "revenue": 4487.85
      },
      {
        "date": "2025-10-12",
        "orderCount": 8,
        "revenue": 2395.92
      }
    ],
    "days": 7,
    "total": 7
  }
}
```

**用途**: 生成销售趋势图表，分析业务增长。

---

### 5. 获取库存预警列表

**端点**: `GET /api/admin/dashboard/low-stock`

**权限**: 需要管理员认证

**查询参数**:
- `threshold` (可选): 预警阈值，默认 10，最大 1000

**请求示例**:
```
GET /api/admin/dashboard/low-stock?threshold=20
```

**响应示例**:
```json
{
  "success": true,
  "data": {
    "products": [
      {
        "id": 5,
        "name": "Adobe Creative Cloud",
        "slug": "adobe-creative-cloud",
        "availableStock": 3
      },
      {
        "id": 8,
        "name": "Autodesk AutoCAD",
        "slug": "autodesk-autocad",
        "availableStock": 7
      }
    ],
    "threshold": 20,
    "total": 2
  }
}
```

**说明**: 返回库存低于阈值的产品，按库存从低到高排序。

---

### 6. 获取产品库存统计

**端点**: `GET /api/admin/dashboard/inventory`

**权限**: 需要管理员认证

**响应示例**:
```json
{
  "success": true,
  "data": {
    "inventory": [
      {
        "id": 1,
        "name": "Windows 11 Pro",
        "slug": "windows-11-pro",
        "total": 250,
        "available": 120,
        "sold": 125,
        "revoked": 5
      },
      {
        "id": 2,
        "name": "Office 2021 Professional",
        "slug": "office-2021-pro",
        "total": 180,
        "available": 85,
        "sold": 90,
        "revoked": 5
      }
    ],
    "total": 2
  }
}
```

**字段说明**:
- `total`: 密钥总数
- `available`: 可用密钥数
- `sold`: 已售出密钥数
- `revoked`: 已作废密钥数

---

### 7. 获取收入统计（按货币）

**端点**: `GET /api/admin/dashboard/revenue-by-currency`

**权限**: 需要管理员认证

**响应示例**:
```json
{
  "success": true,
  "data": {
    "revenues": [
      {
        "currency": "CNY",
        "amount": 125600.50,
        "orderCount": 280
      },
      {
        "currency": "USD",
        "amount": 18500.00,
        "orderCount": 45
      },
      {
        "currency": "EUR",
        "amount": 12300.00,
        "orderCount": 17
      }
    ],
    "total": 3
  }
}
```

**用途**: 分析不同地区的收入分布。

---

### 8. 获取支付方式统计

**端点**: `GET /api/admin/dashboard/payment-methods`

**权限**: 需要管理员认证

**响应示例**:
```json
{
  "success": true,
  "data": {
    "stats": [
      {
        "method": "alipay",
        "count": 185,
        "totalAmount": 55425.50
      },
      {
        "method": "wechat",
        "count": 142,
        "totalAmount": 42530.00
      },
      {
        "method": "paypal",
        "count": 25,
        "totalAmount": 7515.00
      }
    ],
    "total": 3
  }
}
```

**用途**: 了解用户支付偏好，优化支付渠道。

---

### 9. 获取订单统计

**端点**: `GET /api/admin/dashboard/order-stats`

**权限**: 需要管理员认证

**响应示例**:
```json
{
  "success": true,
  "data": {
    "total": 500,
    "pending": 25,
    "paid": 30,
    "completed": 400,
    "cancelled": 40,
    "expired": 5
  }
}
```

---

### 10. 获取产品统计

**端点**: `GET /api/admin/dashboard/product-stats`

**权限**: 需要管理员认证

**响应示例**:
```json
{
  "success": true,
  "data": {
    "total": 15,
    "active": 12,
    "inactive": 3
  }
}
```

---

## 使用示例

### 使用 cURL

**获取仪表盘概览**:
```bash
TOKEN="your-admin-jwt-token"

curl -X GET http://localhost:3000/api/admin/dashboard/overview \
  -H "Authorization: Bearer $TOKEN"
```

**获取最近20条订单**:
```bash
curl -X GET "http://localhost:3000/api/admin/dashboard/recent-orders?limit=20" \
  -H "Authorization: Bearer $TOKEN"
```

**获取热销产品Top 5**:
```bash
curl -X GET "http://localhost:3000/api/admin/dashboard/top-products?limit=5" \
  -H "Authorization: Bearer $TOKEN"
```

**获取30天销售趋势**:
```bash
curl -X GET "http://localhost:3000/api/admin/dashboard/sales-trend?days=30" \
  -H "Authorization: Bearer $TOKEN"
```

### 使用 JavaScript (Fetch API)

```javascript
const token = localStorage.getItem('adminToken');

// 获取仪表盘概览
async function fetchDashboardOverview() {
  const response = await fetch('http://localhost:3000/api/admin/dashboard/overview', {
    headers: {
      'Authorization': `Bearer ${token}`,
    },
  });

  const data = await response.json();

  if (data.success) {
    console.log('Total Revenue:', data.data.totalRevenue.amount);
    console.log('Orders:', data.data.orderStats);
  }
}

// 获取销售趋势
async function fetchSalesTrend(days = 30) {
  const response = await fetch(
    `http://localhost:3000/api/admin/dashboard/sales-trend?days=${days}`,
    {
      headers: {
        'Authorization': `Bearer ${token}`,
      },
    }
  );

  const data = await response.json();

  if (data.success) {
    // 渲染图表
    renderChart(data.data.trend);
  }
}
```

---

## 性能优化

### 1. 并行查询

概览 API (`/overview`) 使用 `Promise.all` 并行查询多个统计数据，提升响应速度：

```javascript
const [totalRevenue, orderStats, productStats] = await Promise.all([
  this.getTotalRevenue(),
  this.getOrderStatistics(),
  this.getProductStatistics(),
]);
```

### 2. 原始 SQL 查询

对于复杂的聚合查询，使用 Prisma 的 `$queryRaw` 提高性能：

```javascript
const products = await prisma.$queryRaw`
  SELECT p.id, p.name, COUNT(oi.id) as order_count
  FROM products p
  INNER JOIN order_items oi ON p.id = oi.product_id
  GROUP BY p.id
  ORDER BY order_count DESC
  LIMIT 10
`;
```

### 3. 缓存建议

对于变化不频繁的统计数据，建议在前端实现缓存：

```javascript
// 缓存5分钟
const CACHE_DURATION = 5 * 60 * 1000;

async function fetchWithCache(url) {
  const cacheKey = `dashboard_${url}`;
  const cached = localStorage.getItem(cacheKey);

  if (cached) {
    const { data, timestamp } = JSON.parse(cached);
    if (Date.now() - timestamp < CACHE_DURATION) {
      return data;
    }
  }

  const response = await fetch(url, {
    headers: { 'Authorization': `Bearer ${token}` },
  });
  const data = await response.json();

  localStorage.setItem(cacheKey, JSON.stringify({
    data,
    timestamp: Date.now(),
  }));

  return data;
}
```

---

## 数据可视化建议

### 1. 销售趋势图

使用折线图或面积图展示 `/sales-trend` 数据：

```javascript
import { Line } from 'react-chartjs-2';

function SalesTrendChart({ trend }) {
  const data = {
    labels: trend.map(t => t.date),
    datasets: [
      {
        label: '销售额',
        data: trend.map(t => t.revenue),
        borderColor: 'rgb(75, 192, 192)',
        tension: 0.1,
      },
      {
        label: '订单数',
        data: trend.map(t => t.orderCount),
        borderColor: 'rgb(255, 99, 132)',
        tension: 0.1,
      },
    ],
  };

  return <Line data={data} />;
}
```

### 2. 订单状态饼图

使用饼图展示订单状态分布：

```javascript
import { Pie } from 'react-chartjs-2';

function OrderStatusChart({ orderStats }) {
  const data = {
    labels: ['待支付', '已支付', '已完成', '已取消', '已过期'],
    datasets: [{
      data: [
        orderStats.pending,
        orderStats.paid,
        orderStats.completed,
        orderStats.cancelled,
        orderStats.expired,
      ],
      backgroundColor: [
        '#FFCE56',
        '#36A2EB',
        '#4BC0C0',
        '#FF6384',
        '#9966FF',
      ],
    }],
  };

  return <Pie data={data} />;
}
```

### 3. 热销产品排行榜

使用条形图展示热销产品：

```javascript
import { Bar } from 'react-chartjs-2';

function TopProductsChart({ products }) {
  const data = {
    labels: products.map(p => p.name),
    datasets: [{
      label: '销售数量',
      data: products.map(p => p.totalSold),
      backgroundColor: 'rgba(75, 192, 192, 0.6)',
    }],
  };

  return <Bar data={data} options={{ indexAxis: 'y' }} />;
}
```

---

## 错误处理

所有 API 在出错时返回 500 状态码：

```json
{
  "success": false,
  "code": "INTERNAL_ERROR",
  "message": "Failed to fetch dashboard overview"
}
```

认证失败返回 401：

```json
{
  "success": false,
  "code": "UNAUTHORIZED",
  "message": "Invalid or expired token"
}
```

---

## 相关文件

```
backend/src/
├── services/
│   └── statistics.service.js      # 统计服务
│
└── routes/admin/
    └── dashboard.js                # 仪表盘路由
```

---

## 扩展建议

### 1. 实时数据推送

使用 WebSocket 实现实时数据更新：

```javascript
// 后端
fastify.register(require('@fastify/websocket'));

fastify.get('/api/admin/dashboard/live', { websocket: true }, (connection, req) => {
  const interval = setInterval(async () => {
    const data = await statisticsService.getDashboardOverview();
    connection.socket.send(JSON.stringify(data));
  }, 5000); // 每5秒推送一次

  connection.socket.on('close', () => clearInterval(interval));
});
```

### 2. 自定义报表

允许管理员自定义时间范围和筛选条件：

```javascript
fastify.get('/api/admin/dashboard/custom-report', {
  schema: {
    querystring: {
      startDate: { type: 'string', format: 'date' },
      endDate: { type: 'string', format: 'date' },
      currency: { type: 'string' },
      status: { type: 'string' },
    },
  },
}, async (request, reply) => {
  // 自定义查询逻辑
});
```

### 3. 数据导出

支持将统计数据导出为 CSV/Excel：

```javascript
import ExcelJS from 'exceljs';

fastify.get('/api/admin/dashboard/export', async (request, reply) => {
  const workbook = new ExcelJS.Workbook();
  const worksheet = workbook.addWorksheet('销售报表');

  // 添加数据
  const trend = await statisticsService.getSalesTrend(30);
  worksheet.addRows(trend);

  // 设置响应头
  reply.header('Content-Type', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
  reply.header('Content-Disposition', 'attachment; filename=report.xlsx');

  // 发送文件
  await workbook.xlsx.write(reply.raw);
  return reply;
});
```

---

## 总结

仪表盘 API 提供了全面的数据统计和分析功能，涵盖销售、订单、库存、支付等多个维度。所有接口都经过优化，支持并行查询和原始 SQL，确保快速响应。配合前端数据可视化组件，可以构建功能强大的管理后台。
