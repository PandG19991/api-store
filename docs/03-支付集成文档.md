# 支付集成文档

## 概述

本系统集成了支付宝和微信支付两种支付方式，支持创建支付订单、接收支付回调、查询支付状态和退款等功能。

---

## 支付方式

### 支付宝
- **支付类型**: 电脑网站支付（PC Web Payment）
- **产品代码**: `FAST_INSTANT_TRADE_PAY`
- **签名方式**: RSA2 (RSA-SHA256)
- **官方文档**: https://opendocs.alipay.com/open/270

### 微信支付
- **支付类型**: Native 扫码支付
- **交易类型**: `NATIVE`
- **签名方式**: MD5
- **官方文档**: https://pay.weixin.qq.com/wiki/doc/api/native.php

---

## 环境配置

### 支付宝配置

在 `.env` 文件中配置以下参数：

```env
# 支付宝配置
ALIPAY_APP_ID=your_app_id                    # 应用 ID
ALIPAY_PRIVATE_KEY=your_private_key          # 应用私钥（RSA2）
ALIPAY_PUBLIC_KEY=alipay_public_key          # 支付宝公钥
```

### 微信支付配置

```env
# 微信支付配置
WECHAT_APP_ID=your_app_id                    # 应用 ID
WECHAT_MCH_ID=your_merchant_id               # 商户号
WECHAT_API_KEY=your_api_key                  # API 密钥
```

### 回调地址配置

```env
# 支付回调地址（生产环境必须是 HTTPS）
PAYMENT_CALLBACK_URL=https://yourdomain.com
```

---

## API 接口

### 1. 获取可用支付方式

**接口**: `GET /api/payments/methods`

**描述**: 获取系统支持的所有支付方式

**响应示例**:
```json
{
  "success": true,
  "data": {
    "methods": [
      {
        "code": "alipay",
        "name": "支付宝",
        "available": true
      },
      {
        "code": "wechat",
        "name": "微信支付",
        "available": true
      }
    ]
  }
}
```

---

### 2. 支付宝支付回调

**接口**: `POST /api/payments/alipay/notify`

**描述**: 接收支付宝异步支付通知（由支付宝服务器调用）

**请求参数** (表单格式):
```
out_trade_no: 商户订单号
trade_no: 支付宝交易号
trade_status: 交易状态 (TRADE_SUCCESS, TRADE_FINISHED)
total_amount: 订单金额
... 其他参数
sign: 签名
```

**响应**:
- 成功: `success`
- 失败: `fail`

**交易状态说明**:
- `TRADE_SUCCESS`: 交易成功
- `TRADE_FINISHED`: 交易完成（不可退款）
- `WAIT_BUYER_PAY`: 等待买家付款

---

### 3. 支付宝同步返回

**接口**: `GET /api/payments/alipay/return`

**描述**: 支付完成后跳转的同步返回地址

**功能**: 验证签名后重定向到前端订单详情页

**重定向地址**: `${FRONTEND_URL}/orders/{orderNo}?success=true`

---

### 4. 微信支付回调

**接口**: `POST /api/payments/wechat/notify`

**描述**: 接收微信支付异步通知（由微信支付服务器调用）

**请求格式**: XML

**请求示例**:
```xml
<xml>
  <return_code><![CDATA[SUCCESS]]></return_code>
  <result_code><![CDATA[SUCCESS]]></result_code>
  <out_trade_no><![CDATA[ORD20250116123456]]></out_trade_no>
  <transaction_id><![CDATA[4200001234567890]]></transaction_id>
  <total_fee>9900</total_fee>
  <sign><![CDATA[...]]></sign>
</xml>
```

**响应格式**: XML

**成功响应**:
```xml
<xml>
  <return_code><![CDATA[SUCCESS]]></return_code>
  <return_msg><![CDATA[OK]]></return_msg>
</xml>
```

**失败响应**:
```xml
<xml>
  <return_code><![CDATA[FAIL]]></return_code>
  <return_msg><![CDATA[签名失败]]></return_msg>
</xml>
```

---

### 5. 查询支付状态

**接口**: `POST /api/payments/:method/query`

**描述**: 主动查询订单支付状态

**路径参数**:
- `method`: 支付方式 (`alipay` | `wechat`)

**请求体**:
```json
{
  "orderNo": "ORD20250116123456"
}
```

**响应示例** (支付宝):
```json
{
  "success": true,
  "data": {
    "success": true,
    "tradeNo": "2025011622001234567890",
    "orderNo": "ORD20250116123456",
    "tradeStatus": "TRADE_SUCCESS",
    "totalAmount": "99.00"
  }
}
```

**响应示例** (微信):
```json
{
  "success": true,
  "data": {
    "success": true,
    "tradeNo": "4200001234567890",
    "orderNo": "ORD20250116123456",
    "tradeState": "SUCCESS",
    "totalFee": 99.00
  }
}
```

---

### 6. 退款

**接口**: `POST /api/payments/:method/refund`

**描述**: 处理订单退款（需要管理员权限）

**路径参数**:
- `method`: 支付方式 (`alipay` | `wechat`)

**请求体** (支付宝):
```json
{
  "orderNo": "ORD20250116123456",
  "refundAmount": 99.00,
  "refundReason": "用户申请退款"
}
```

**请求体** (微信):
```json
{
  "orderNo": "ORD20250116123456",
  "refundAmount": 99.00,
  "totalAmount": 99.00
}
```

**响应示例**:
```json
{
  "success": true,
  "data": {
    "success": true,
    "refundFee": "99.00",
    "gmtRefundPay": "2025-01-16 12:34:56"
  }
}
```

---

## 支付流程

### 支付宝支付流程

```
1. 用户下单
   ↓
2. 调用 PaymentService.createPayment('alipay', {...})
   ↓
3. 生成支付表单 URL
   ↓
4. 前端跳转到支付宝收银台
   ↓
5. 用户完成支付
   ↓
6. 支付宝发送异步通知到 /api/payments/alipay/notify
   ↓
7. 验证签名 → 更新订单状态 → 分配密钥
   ↓
8. 同步返回到 /api/payments/alipay/return
   ↓
9. 重定向到前端订单详情页
```

### 微信支付流程

```
1. 用户下单
   ↓
2. 调用 PaymentService.createPayment('wechat', {...})
   ↓
3. 获取支付二维码链接
   ↓
4. 前端展示二维码
   ↓
5. 用户扫码支付
   ↓
6. 微信发送异步通知到 /api/payments/wechat/notify
   ↓
7. 验证签名 → 更新订单状态 → 分配密钥
```

---

## PaymentService API

### createPayment()

创建支付订单

```javascript
import paymentService from './services/payment.service.js';

const result = await paymentService.createPayment('alipay', {
  orderNo: 'ORD20250116123456',
  amount: 99.00,
  subject: 'ChatGPT Plus 会员 - 1个月',
  description: '购买 ChatGPT Plus 会员服务',
});

// 支付宝返回
// {
//   method: 'alipay',
//   paymentUrl: 'https://openapi.alipay.com/gateway.do?...',
//   orderNo: 'ORD20250116123456'
// }

// 微信返回
// {
//   method: 'wechat',
//   qrCodeUrl: 'weixin://wxpay/bizpayurl?pr=xxxxx',
//   orderNo: 'ORD20250116123456'
// }
```

### verifyCallback()

验证支付回调签名

```javascript
const isValid = paymentService.verifyCallback('alipay', {
  out_trade_no: 'ORD20250116123456',
  trade_no: '2025011622001234567890',
  total_amount: '99.00',
  sign: 'xxx...',
  // ... 其他参数
});

if (isValid) {
  // 处理支付成功逻辑
}
```

### queryPayment()

查询支付状态

```javascript
const result = await paymentService.queryPayment('alipay', 'ORD20250116123456');

console.log(result);
// {
//   success: true,
//   tradeNo: '2025011622001234567890',
//   orderNo: 'ORD20250116123456',
//   tradeStatus: 'TRADE_SUCCESS',
//   totalAmount: '99.00'
// }
```

### refund()

退款

```javascript
const result = await paymentService.refund('alipay', {
  orderNo: 'ORD20250116123456',
  refundAmount: 99.00,
  refundReason: '用户申请退款',
});

console.log(result);
// {
//   success: true,
//   refundFee: '99.00',
//   gmtRefundPay: '2025-01-16 12:34:56'
// }
```

---

## 安全注意事项

### 1. 签名验证

- ✅ 所有支付回调都必须验证签名
- ✅ 签名不匹配时拒绝处理请求
- ✅ 使用官方提供的公钥进行验证

### 2. 金额校验

- ✅ 验证回调中的金额是否与订单金额一致
- ✅ 防止金额篡改攻击

### 3. 订单状态检查

- ✅ 检查订单是否已处理，避免重复处理
- ✅ 使用事务确保订单状态原子性更新

### 4. HTTPS 要求

- ⚠️ 生产环境必须使用 HTTPS
- ⚠️ 回调地址必须是公网可访问的 HTTPS 地址

### 5. 密钥保护

- ⚠️ 不要将私钥提交到版本控制系统
- ⚠️ 使用环境变量存储敏感配置
- ⚠️ 定期轮换 API 密钥

---

## 错误处理

### 常见错误

#### 1. 配置未设置
```
BadRequestError: Alipay not configured
```
**解决**: 检查 `.env` 文件中的支付宝配置

#### 2. 签名验证失败
```
[Alipay] Invalid signature
```
**解决**:
- 检查支付宝公钥是否正确
- 确认私钥与应用匹配

#### 3. 支付查询失败
```
BadRequestError: Failed to query payment status
```
**解决**:
- 检查订单号是否正确
- 确认支付网关连接正常

---

## 测试

### 沙箱环境

**支付宝沙箱**:
- 网关地址: `https://openapi.alipaydev.com/gateway.do`
- 开发者中心: https://open.alipay.com/develop/sandbox/app

**微信支付沙箱**:
- 申请地址: https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=23_1

### 测试账号

使用官方提供的测试账号和测试金额进行支付测试。

---

## 后续集成步骤

目前支付服务已经完成基础框架，但需要与订单服务集成才能完整运行：

1. **创建订单服务** (Task 8)
   - 实现订单创建逻辑
   - 处理支付回调
   - 分配密钥

2. **在订单服务中调用支付服务**
   ```javascript
   // 创建订单时
   const payment = await paymentService.createPayment(method, {
     orderNo: order.orderNo,
     amount: order.totalAmount,
     subject: product.name,
     description: product.description
   });
   ```

3. **处理支付回调**
   ```javascript
   // 在 payment routes 中
   const result = await orderService.handlePaymentCallback({
     orderNo,
     transactionId,
     paymentMethod,
     status: 'success',
     amount: totalAmount
   });
   ```

---

## 文件结构

```
backend/src/
├── services/
│   └── payment.service.js       # 支付服务（已完成）
│       ├── AlipayProvider       # 支付宝支付提供商
│       ├── WechatPayProvider    # 微信支付提供商
│       └── PaymentService       # 统一支付服务接口
│
└── routes/
    └── public/
        └── payments.js          # 支付路由（已完成）
            ├── GET  /methods                  # 获取支付方式
            ├── POST /alipay/notify            # 支付宝回调
            ├── GET  /alipay/return            # 支付宝同步返回
            ├── POST /wechat/notify            # 微信回调
            ├── POST /:method/query            # 查询支付状态
            └── POST /:method/refund           # 退款
```

---

## 总结

✅ **已完成**:
- 支付宝电脑网站支付集成
- 微信 Native 扫码支付集成
- 签名验证功能
- 支付查询功能
- 退款功能
- 支付回调处理框架

⏳ **待完成**:
- 与订单服务集成
- 完整的支付流程测试
- 生产环境配置

📝 **注意**:
- 当前代码中的 `TODO` 注释需要在订单服务实现后进行集成
- 退款接口后续需要移到管理后台路由并添加权限验证
