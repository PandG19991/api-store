# æ”¯ä»˜é›†æˆæ–‡æ¡£

## æ¦‚è¿°

æœ¬ç³»ç»Ÿé›†æˆäº†æ”¯ä»˜å®å’Œå¾®ä¿¡æ”¯ä»˜ä¸¤ç§æ”¯ä»˜æ–¹å¼ï¼Œæ”¯æŒåˆ›å»ºæ”¯ä»˜è®¢å•ã€æ¥æ”¶æ”¯ä»˜å›è°ƒã€æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€å’Œé€€æ¬¾ç­‰åŠŸèƒ½ã€‚

---

## æ”¯ä»˜æ–¹å¼

### æ”¯ä»˜å®
- **æ”¯ä»˜ç±»å‹**: ç”µè„‘ç½‘ç«™æ”¯ä»˜ï¼ˆPC Web Paymentï¼‰
- **äº§å“ä»£ç **: `FAST_INSTANT_TRADE_PAY`
- **ç­¾åæ–¹å¼**: RSA2 (RSA-SHA256)
- **å®˜æ–¹æ–‡æ¡£**: https://opendocs.alipay.com/open/270

### å¾®ä¿¡æ”¯ä»˜
- **æ”¯ä»˜ç±»å‹**: Native æ‰«ç æ”¯ä»˜
- **äº¤æ˜“ç±»å‹**: `NATIVE`
- **ç­¾åæ–¹å¼**: MD5
- **å®˜æ–¹æ–‡æ¡£**: https://pay.weixin.qq.com/wiki/doc/api/native.php

---

## ç¯å¢ƒé…ç½®

### æ”¯ä»˜å®é…ç½®

åœ¨ `.env` æ–‡ä»¶ä¸­é…ç½®ä»¥ä¸‹å‚æ•°ï¼š

```env
# æ”¯ä»˜å®é…ç½®
ALIPAY_APP_ID=your_app_id                    # åº”ç”¨ ID
ALIPAY_PRIVATE_KEY=your_private_key          # åº”ç”¨ç§é’¥ï¼ˆRSA2ï¼‰
ALIPAY_PUBLIC_KEY=alipay_public_key          # æ”¯ä»˜å®å…¬é’¥
```

### å¾®ä¿¡æ”¯ä»˜é…ç½®

```env
# å¾®ä¿¡æ”¯ä»˜é…ç½®
WECHAT_APP_ID=your_app_id                    # åº”ç”¨ ID
WECHAT_MCH_ID=your_merchant_id               # å•†æˆ·å·
WECHAT_API_KEY=your_api_key                  # API å¯†é’¥
```

### å›è°ƒåœ°å€é…ç½®

```env
# æ”¯ä»˜å›è°ƒåœ°å€ï¼ˆç”Ÿäº§ç¯å¢ƒå¿…é¡»æ˜¯ HTTPSï¼‰
PAYMENT_CALLBACK_URL=https://yourdomain.com
```

---

## API æ¥å£

### 1. è·å–å¯ç”¨æ”¯ä»˜æ–¹å¼

**æ¥å£**: `GET /api/payments/methods`

**æè¿°**: è·å–ç³»ç»Ÿæ”¯æŒçš„æ‰€æœ‰æ”¯ä»˜æ–¹å¼

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "data": {
    "methods": [
      {
        "code": "alipay",
        "name": "æ”¯ä»˜å®",
        "available": true
      },
      {
        "code": "wechat",
        "name": "å¾®ä¿¡æ”¯ä»˜",
        "available": true
      }
    ]
  }
}
```

---

### 2. æ”¯ä»˜å®æ”¯ä»˜å›è°ƒ

**æ¥å£**: `POST /api/payments/alipay/notify`

**æè¿°**: æ¥æ”¶æ”¯ä»˜å®å¼‚æ­¥æ”¯ä»˜é€šçŸ¥ï¼ˆç”±æ”¯ä»˜å®æœåŠ¡å™¨è°ƒç”¨ï¼‰

**è¯·æ±‚å‚æ•°** (è¡¨å•æ ¼å¼):
```
out_trade_no: å•†æˆ·è®¢å•å·
trade_no: æ”¯ä»˜å®äº¤æ˜“å·
trade_status: äº¤æ˜“çŠ¶æ€ (TRADE_SUCCESS, TRADE_FINISHED)
total_amount: è®¢å•é‡‘é¢
... å…¶ä»–å‚æ•°
sign: ç­¾å
```

**å“åº”**:
- æˆåŠŸ: `success`
- å¤±è´¥: `fail`

**äº¤æ˜“çŠ¶æ€è¯´æ˜**:
- `TRADE_SUCCESS`: äº¤æ˜“æˆåŠŸ
- `TRADE_FINISHED`: äº¤æ˜“å®Œæˆï¼ˆä¸å¯é€€æ¬¾ï¼‰
- `WAIT_BUYER_PAY`: ç­‰å¾…ä¹°å®¶ä»˜æ¬¾

---

### 3. æ”¯ä»˜å®åŒæ­¥è¿”å›

**æ¥å£**: `GET /api/payments/alipay/return`

**æè¿°**: æ”¯ä»˜å®Œæˆåè·³è½¬çš„åŒæ­¥è¿”å›åœ°å€

**åŠŸèƒ½**: éªŒè¯ç­¾ååé‡å®šå‘åˆ°å‰ç«¯è®¢å•è¯¦æƒ…é¡µ

**é‡å®šå‘åœ°å€**: `${FRONTEND_URL}/orders/{orderNo}?success=true`

---

### 4. å¾®ä¿¡æ”¯ä»˜å›è°ƒ

**æ¥å£**: `POST /api/payments/wechat/notify`

**æè¿°**: æ¥æ”¶å¾®ä¿¡æ”¯ä»˜å¼‚æ­¥é€šçŸ¥ï¼ˆç”±å¾®ä¿¡æ”¯ä»˜æœåŠ¡å™¨è°ƒç”¨ï¼‰

**è¯·æ±‚æ ¼å¼**: XML

**è¯·æ±‚ç¤ºä¾‹**:
```xml
<xml>
  <return_code><![CDATA[SUCCESS]]></return_code>
  <result_code><![CDATA[SUCCESS]]></result_code>
  <out_trade_no><![CDATA[ORD20250116123456]]></out_trade_no>
  <transaction_id><![CDATA[4200001234567890]]></transaction_id>
  <total_fee>9900</total_fee>
  <sign><![CDATA[...]]></sign>
</xml>
```

**å“åº”æ ¼å¼**: XML

**æˆåŠŸå“åº”**:
```xml
<xml>
  <return_code><![CDATA[SUCCESS]]></return_code>
  <return_msg><![CDATA[OK]]></return_msg>
</xml>
```

**å¤±è´¥å“åº”**:
```xml
<xml>
  <return_code><![CDATA[FAIL]]></return_code>
  <return_msg><![CDATA[ç­¾åå¤±è´¥]]></return_msg>
</xml>
```

---

### 5. æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€

**æ¥å£**: `POST /api/payments/:method/query`

**æè¿°**: ä¸»åŠ¨æŸ¥è¯¢è®¢å•æ”¯ä»˜çŠ¶æ€

**è·¯å¾„å‚æ•°**:
- `method`: æ”¯ä»˜æ–¹å¼ (`alipay` | `wechat`)

**è¯·æ±‚ä½“**:
```json
{
  "orderNo": "ORD20250116123456"
}
```

**å“åº”ç¤ºä¾‹** (æ”¯ä»˜å®):
```json
{
  "success": true,
  "data": {
    "success": true,
    "tradeNo": "2025011622001234567890",
    "orderNo": "ORD20250116123456",
    "tradeStatus": "TRADE_SUCCESS",
    "totalAmount": "99.00"
  }
}
```

**å“åº”ç¤ºä¾‹** (å¾®ä¿¡):
```json
{
  "success": true,
  "data": {
    "success": true,
    "tradeNo": "4200001234567890",
    "orderNo": "ORD20250116123456",
    "tradeState": "SUCCESS",
    "totalFee": 99.00
  }
}
```

---

### 6. é€€æ¬¾

**æ¥å£**: `POST /api/payments/:method/refund`

**æè¿°**: å¤„ç†è®¢å•é€€æ¬¾ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰

**è·¯å¾„å‚æ•°**:
- `method`: æ”¯ä»˜æ–¹å¼ (`alipay` | `wechat`)

**è¯·æ±‚ä½“** (æ”¯ä»˜å®):
```json
{
  "orderNo": "ORD20250116123456",
  "refundAmount": 99.00,
  "refundReason": "ç”¨æˆ·ç”³è¯·é€€æ¬¾"
}
```

**è¯·æ±‚ä½“** (å¾®ä¿¡):
```json
{
  "orderNo": "ORD20250116123456",
  "refundAmount": 99.00,
  "totalAmount": 99.00
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "data": {
    "success": true,
    "refundFee": "99.00",
    "gmtRefundPay": "2025-01-16 12:34:56"
  }
}
```

---

## æ”¯ä»˜æµç¨‹

### æ”¯ä»˜å®æ”¯ä»˜æµç¨‹

```
1. ç”¨æˆ·ä¸‹å•
   â†“
2. è°ƒç”¨ PaymentService.createPayment('alipay', {...})
   â†“
3. ç”Ÿæˆæ”¯ä»˜è¡¨å• URL
   â†“
4. å‰ç«¯è·³è½¬åˆ°æ”¯ä»˜å®æ”¶é“¶å°
   â†“
5. ç”¨æˆ·å®Œæˆæ”¯ä»˜
   â†“
6. æ”¯ä»˜å®å‘é€å¼‚æ­¥é€šçŸ¥åˆ° /api/payments/alipay/notify
   â†“
7. éªŒè¯ç­¾å â†’ æ›´æ–°è®¢å•çŠ¶æ€ â†’ åˆ†é…å¯†é’¥
   â†“
8. åŒæ­¥è¿”å›åˆ° /api/payments/alipay/return
   â†“
9. é‡å®šå‘åˆ°å‰ç«¯è®¢å•è¯¦æƒ…é¡µ
```

### å¾®ä¿¡æ”¯ä»˜æµç¨‹

```
1. ç”¨æˆ·ä¸‹å•
   â†“
2. è°ƒç”¨ PaymentService.createPayment('wechat', {...})
   â†“
3. è·å–æ”¯ä»˜äºŒç»´ç é“¾æ¥
   â†“
4. å‰ç«¯å±•ç¤ºäºŒç»´ç 
   â†“
5. ç”¨æˆ·æ‰«ç æ”¯ä»˜
   â†“
6. å¾®ä¿¡å‘é€å¼‚æ­¥é€šçŸ¥åˆ° /api/payments/wechat/notify
   â†“
7. éªŒè¯ç­¾å â†’ æ›´æ–°è®¢å•çŠ¶æ€ â†’ åˆ†é…å¯†é’¥
```

---

## PaymentService API

### createPayment()

åˆ›å»ºæ”¯ä»˜è®¢å•

```javascript
import paymentService from './services/payment.service.js';

const result = await paymentService.createPayment('alipay', {
  orderNo: 'ORD20250116123456',
  amount: 99.00,
  subject: 'ChatGPT Plus ä¼šå‘˜ - 1ä¸ªæœˆ',
  description: 'è´­ä¹° ChatGPT Plus ä¼šå‘˜æœåŠ¡',
});

// æ”¯ä»˜å®è¿”å›
// {
//   method: 'alipay',
//   paymentUrl: 'https://openapi.alipay.com/gateway.do?...',
//   orderNo: 'ORD20250116123456'
// }

// å¾®ä¿¡è¿”å›
// {
//   method: 'wechat',
//   qrCodeUrl: 'weixin://wxpay/bizpayurl?pr=xxxxx',
//   orderNo: 'ORD20250116123456'
// }
```

### verifyCallback()

éªŒè¯æ”¯ä»˜å›è°ƒç­¾å

```javascript
const isValid = paymentService.verifyCallback('alipay', {
  out_trade_no: 'ORD20250116123456',
  trade_no: '2025011622001234567890',
  total_amount: '99.00',
  sign: 'xxx...',
  // ... å…¶ä»–å‚æ•°
});

if (isValid) {
  // å¤„ç†æ”¯ä»˜æˆåŠŸé€»è¾‘
}
```

### queryPayment()

æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€

```javascript
const result = await paymentService.queryPayment('alipay', 'ORD20250116123456');

console.log(result);
// {
//   success: true,
//   tradeNo: '2025011622001234567890',
//   orderNo: 'ORD20250116123456',
//   tradeStatus: 'TRADE_SUCCESS',
//   totalAmount: '99.00'
// }
```

### refund()

é€€æ¬¾

```javascript
const result = await paymentService.refund('alipay', {
  orderNo: 'ORD20250116123456',
  refundAmount: 99.00,
  refundReason: 'ç”¨æˆ·ç”³è¯·é€€æ¬¾',
});

console.log(result);
// {
//   success: true,
//   refundFee: '99.00',
//   gmtRefundPay: '2025-01-16 12:34:56'
// }
```

---

## å®‰å…¨æ³¨æ„äº‹é¡¹

### 1. ç­¾åéªŒè¯

- âœ… æ‰€æœ‰æ”¯ä»˜å›è°ƒéƒ½å¿…é¡»éªŒè¯ç­¾å
- âœ… ç­¾åä¸åŒ¹é…æ—¶æ‹’ç»å¤„ç†è¯·æ±‚
- âœ… ä½¿ç”¨å®˜æ–¹æä¾›çš„å…¬é’¥è¿›è¡ŒéªŒè¯

### 2. é‡‘é¢æ ¡éªŒ

- âœ… éªŒè¯å›è°ƒä¸­çš„é‡‘é¢æ˜¯å¦ä¸è®¢å•é‡‘é¢ä¸€è‡´
- âœ… é˜²æ­¢é‡‘é¢ç¯¡æ”¹æ”»å‡»

### 3. è®¢å•çŠ¶æ€æ£€æŸ¥

- âœ… æ£€æŸ¥è®¢å•æ˜¯å¦å·²å¤„ç†ï¼Œé¿å…é‡å¤å¤„ç†
- âœ… ä½¿ç”¨äº‹åŠ¡ç¡®ä¿è®¢å•çŠ¶æ€åŸå­æ€§æ›´æ–°

### 4. HTTPS è¦æ±‚

- âš ï¸ ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨ HTTPS
- âš ï¸ å›è°ƒåœ°å€å¿…é¡»æ˜¯å…¬ç½‘å¯è®¿é—®çš„ HTTPS åœ°å€

### 5. å¯†é’¥ä¿æŠ¤

- âš ï¸ ä¸è¦å°†ç§é’¥æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿ
- âš ï¸ ä½¿ç”¨ç¯å¢ƒå˜é‡å­˜å‚¨æ•æ„Ÿé…ç½®
- âš ï¸ å®šæœŸè½®æ¢ API å¯†é’¥

---

## é”™è¯¯å¤„ç†

### å¸¸è§é”™è¯¯

#### 1. é…ç½®æœªè®¾ç½®
```
BadRequestError: Alipay not configured
```
**è§£å†³**: æ£€æŸ¥ `.env` æ–‡ä»¶ä¸­çš„æ”¯ä»˜å®é…ç½®

#### 2. ç­¾åéªŒè¯å¤±è´¥
```
[Alipay] Invalid signature
```
**è§£å†³**:
- æ£€æŸ¥æ”¯ä»˜å®å…¬é’¥æ˜¯å¦æ­£ç¡®
- ç¡®è®¤ç§é’¥ä¸åº”ç”¨åŒ¹é…

#### 3. æ”¯ä»˜æŸ¥è¯¢å¤±è´¥
```
BadRequestError: Failed to query payment status
```
**è§£å†³**:
- æ£€æŸ¥è®¢å•å·æ˜¯å¦æ­£ç¡®
- ç¡®è®¤æ”¯ä»˜ç½‘å…³è¿æ¥æ­£å¸¸

---

## æµ‹è¯•

### æ²™ç®±ç¯å¢ƒ

**æ”¯ä»˜å®æ²™ç®±**:
- ç½‘å…³åœ°å€: `https://openapi.alipaydev.com/gateway.do`
- å¼€å‘è€…ä¸­å¿ƒ: https://open.alipay.com/develop/sandbox/app

**å¾®ä¿¡æ”¯ä»˜æ²™ç®±**:
- ç”³è¯·åœ°å€: https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=23_1

### æµ‹è¯•è´¦å·

ä½¿ç”¨å®˜æ–¹æä¾›çš„æµ‹è¯•è´¦å·å’Œæµ‹è¯•é‡‘é¢è¿›è¡Œæ”¯ä»˜æµ‹è¯•ã€‚

---

## åç»­é›†æˆæ­¥éª¤

ç›®å‰æ”¯ä»˜æœåŠ¡å·²ç»å®ŒæˆåŸºç¡€æ¡†æ¶ï¼Œä½†éœ€è¦ä¸è®¢å•æœåŠ¡é›†æˆæ‰èƒ½å®Œæ•´è¿è¡Œï¼š

1. **åˆ›å»ºè®¢å•æœåŠ¡** (Task 8)
   - å®ç°è®¢å•åˆ›å»ºé€»è¾‘
   - å¤„ç†æ”¯ä»˜å›è°ƒ
   - åˆ†é…å¯†é’¥

2. **åœ¨è®¢å•æœåŠ¡ä¸­è°ƒç”¨æ”¯ä»˜æœåŠ¡**
   ```javascript
   // åˆ›å»ºè®¢å•æ—¶
   const payment = await paymentService.createPayment(method, {
     orderNo: order.orderNo,
     amount: order.totalAmount,
     subject: product.name,
     description: product.description
   });
   ```

3. **å¤„ç†æ”¯ä»˜å›è°ƒ**
   ```javascript
   // åœ¨ payment routes ä¸­
   const result = await orderService.handlePaymentCallback({
     orderNo,
     transactionId,
     paymentMethod,
     status: 'success',
     amount: totalAmount
   });
   ```

---

## æ–‡ä»¶ç»“æ„

```
backend/src/
â”œâ”€â”€ services/
â”‚   â””â”€â”€ payment.service.js       # æ”¯ä»˜æœåŠ¡ï¼ˆå·²å®Œæˆï¼‰
â”‚       â”œâ”€â”€ AlipayProvider       # æ”¯ä»˜å®æ”¯ä»˜æä¾›å•†
â”‚       â”œâ”€â”€ WechatPayProvider    # å¾®ä¿¡æ”¯ä»˜æä¾›å•†
â”‚       â””â”€â”€ PaymentService       # ç»Ÿä¸€æ”¯ä»˜æœåŠ¡æ¥å£
â”‚
â””â”€â”€ routes/
    â””â”€â”€ public/
        â””â”€â”€ payments.js          # æ”¯ä»˜è·¯ç”±ï¼ˆå·²å®Œæˆï¼‰
            â”œâ”€â”€ GET  /methods                  # è·å–æ”¯ä»˜æ–¹å¼
            â”œâ”€â”€ POST /alipay/notify            # æ”¯ä»˜å®å›è°ƒ
            â”œâ”€â”€ GET  /alipay/return            # æ”¯ä»˜å®åŒæ­¥è¿”å›
            â”œâ”€â”€ POST /wechat/notify            # å¾®ä¿¡å›è°ƒ
            â”œâ”€â”€ POST /:method/query            # æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€
            â””â”€â”€ POST /:method/refund           # é€€æ¬¾
```

---

## æ€»ç»“

âœ… **å·²å®Œæˆ**:
- æ”¯ä»˜å®ç”µè„‘ç½‘ç«™æ”¯ä»˜é›†æˆ
- å¾®ä¿¡ Native æ‰«ç æ”¯ä»˜é›†æˆ
- ç­¾åéªŒè¯åŠŸèƒ½
- æ”¯ä»˜æŸ¥è¯¢åŠŸèƒ½
- é€€æ¬¾åŠŸèƒ½
- æ”¯ä»˜å›è°ƒå¤„ç†æ¡†æ¶

â³ **å¾…å®Œæˆ**:
- ä¸è®¢å•æœåŠ¡é›†æˆ
- å®Œæ•´çš„æ”¯ä»˜æµç¨‹æµ‹è¯•
- ç”Ÿäº§ç¯å¢ƒé…ç½®

ğŸ“ **æ³¨æ„**:
- å½“å‰ä»£ç ä¸­çš„ `TODO` æ³¨é‡Šéœ€è¦åœ¨è®¢å•æœåŠ¡å®ç°åè¿›è¡Œé›†æˆ
- é€€æ¬¾æ¥å£åç»­éœ€è¦ç§»åˆ°ç®¡ç†åå°è·¯ç”±å¹¶æ·»åŠ æƒé™éªŒè¯
