# 库存预警服务文档

## 概述

库存预警服务自动监控产品密钥库存，当库存低于设定阈值时通过多种渠道（邮件、微信）发送预警通知，帮助管理员及时补货。

---

## 核心功能

### 1. 自动库存监控
- ✅ 定时检查所有上架产品的密钥库存
- ✅ 检测库存是否低于预警阈值
- ✅ 支持自定义检查间隔（默认 1 小时）
- ✅ 仅监控状态为 `active` 的产品

### 2. 多渠道通知
- ✅ **邮件通知** - 发送详细的库存预警邮件给管理员
- ✅ **微信通知 (Server酱)** - 通过 Server酱 推送微信消息
- ✅ **企业微信机器人** - 发送 Markdown 格式消息到企业微信群

### 3. 防重复通知
- ✅ 使用 Redis 缓存防止短时间内重复发送预警
- ✅ 默认冷却期 24 小时
- ✅ 可手动重置冷却状态

### 4. 库存报告
- ✅ 生成完整的库存状态报告
- ✅ 统计健康库存、低库存、缺货产品数量
- ✅ 支持手动触发检查

---

## 环境配置

### 必需配置

在 `.env` 文件中添加：

```env
# 库存预警阈值（密钥数量）
INVENTORY_ALERT_THRESHOLD=10

# 管理员邮箱（接收预警）
INVENTORY_ADMIN_EMAIL=admin@yourstore.com

# 检查间隔（秒，0 表示禁用自动监控）
INVENTORY_CHECK_INTERVAL=3600
```

### 邮件通知配置

```env
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
EMAIL_FROM=noreply@yourstore.com
EMAIL_FROM_NAME=虚拟产品商店
```

### Server酱配置（可选）

1. 注册 Server酱账号: https://sct.ftqq.com/
2. 获取 SendKey
3. 配置环境变量:

```env
SERVERCHAN_SEND_KEY=SCT123456ABCDxxxxxxxxxxxxxx
```

### 企业微信机器人配置（可选）

1. 创建企业微信群机器人
2. 获取 Webhook URL
3. 配置环境变量:

```env
WECOM_WEBHOOK_URL=https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxxxx
```

---

## 使用方法

### 启动监控

库存监控会在服务器启动时自动开启（如果配置了 `INVENTORY_CHECK_INTERVAL > 0`）。

启动日志示例：
```
✅ Inventory monitoring started
📦 Inventory Monitoring: ENABLED
   - Threshold: 10
   - Check Interval: 3600s
   - Alert Channels: Email, ServerChan
```

### 手动检查

通过程序化方式手动触发检查：

```javascript
import inventoryService from './services/inventory.service.js';

// 手动触发检查
const result = await inventoryService.manualCheck();

console.log(result);
// {
//   checkedAt: 2025-10-16T10:30:00.000Z,
//   totalProducts: 10,
//   lowStockCount: 2,
//   alertsSent: 2,
//   lowStockProducts: [
//     { id: 1, name: 'ChatGPT Plus', stock: 5 },
//     { id: 2, name: 'Midjourney', stock: 8 }
//   ]
// }
```

### 查看监控状态

```javascript
const status = inventoryService.getMonitoringStatus();

console.log(status);
// {
//   isMonitoring: true,
//   alertThreshold: 10,
//   checkInterval: 3600,
//   cooldownPeriod: 86400,
//   adminEmail: 'admin@yourstore.com',
//   wechatConfigured: true,
//   enabledChannels: ['Email', 'ServerChan']
// }
```

### 获取库存报告

```javascript
const report = await inventoryService.getStockReport();

console.log(report);
// {
//   generatedAt: 2025-10-16T10:30:00.000Z,
//   totalProducts: 10,
//   lowStockProducts: 2,
//   outOfStockProducts: 1,
//   healthyStockProducts: 7,
//   products: [
//     { id: 1, name: 'Product A', stock: 5, status: 'LOW_STOCK' },
//     { id: 2, name: 'Product B', stock: 0, status: 'OUT_OF_STOCK' },
//     { id: 3, name: 'Product C', stock: 50, status: 'HEALTHY' }
//   ],
//   alertThreshold: 10
// }
```

### 重置预警冷却

```javascript
// 重置指定产品的预警冷却，允许立即发送新预警
await inventoryService.resetAlertCooldown(productId);
```

---

## 通知内容

### 邮件通知示例

**主题**: ⚠️ 库存预警 - ChatGPT Plus 会员

**内容**:
```
📦 产品信息

- 产品名称: ChatGPT Plus 会员
- 产品 ID: 1
- 当前库存: 5 个
- 预警阈值: 10 个
- 产品状态: ✅ 上架中

⚠️ 警告

当前库存已低于预警阈值，请及时补货！

💡 建议操作

1. 登录管理后台查看详细库存
2. 批量导入新的密钥
3. 如库存耗尽，考虑临时下架产品

时间: 2025-10-16 10:30:00
```

### Server酱微信通知示例

```
⚠️ 库存预警 - ChatGPT Plus 会员

### 📦 产品信息

- **产品名称**: ChatGPT Plus 会员
- **产品 ID**: 1
- **当前库存**: **5** 个
- **预警阈值**: 10 个
- **产品状态**: ✅ 上架中

---

### ⚠️ 警告

当前库存已低于预警阈值，请及时补货！

---

### 💡 建议操作

1. 登录管理后台查看详细库存
2. 批量导入新的密钥
3. 如库存耗尽，考虑临时下架产品

---

**时间**: 2025-10-16 10:30:00
```

---

## API 方法

### InventoryService

#### `checkProductStock(productId)`

检查单个产品的库存状态。

```javascript
const stockInfo = await inventoryService.checkProductStock(1);
// {
//   productId: 1,
//   productName: 'ChatGPT Plus',
//   stockCount: 5,
//   threshold: 10,
//   isLowStock: true,
//   status: 'active'
// }
```

#### `checkAllStock()`

检查所有上架产品的库存。

```javascript
const allStock = await inventoryService.checkAllStock();
// [
//   { productId: 1, productName: 'Product A', stockCount: 5, ... },
//   { productId: 2, productName: 'Product B', stockCount: 20, ... }
// ]
```

#### `getLowStockProducts()`

获取所有低库存产品列表。

```javascript
const lowStock = await inventoryService.getLowStockProducts();
// [
//   { productId: 1, productName: 'Product A', stockCount: 5, isLowStock: true }
// ]
```

#### `sendStockAlert(product, stockCount)`

发送库存预警通知。

```javascript
const result = await inventoryService.sendStockAlert(product, 5);
// {
//   success: true,
//   results: {
//     email: { success: true, messageId: 'xxx' },
//     wechat: { success: true, results: { serverChan: { success: true } } }
//   }
// }
```

#### `checkAndAlert()`

检查库存并发送预警（带冷却控制）。

```javascript
const result = await inventoryService.checkAndAlert();
```

#### `startMonitoring(interval)`

启动定时监控。

```javascript
inventoryService.startMonitoring(3600); // 每小时检查一次
```

#### `stopMonitoring()`

停止定时监控。

```javascript
inventoryService.stopMonitoring();
```

#### `getMonitoringStatus()`

获取监控状态信息。

```javascript
const status = inventoryService.getMonitoringStatus();
```

#### `getStockReport()`

生成库存报告。

```javascript
const report = await inventoryService.getStockReport();
```

---

## NotificationService

### Server酱通知

```javascript
import notificationService from './services/notification.service.js';

// 发送自定义通知
await notificationService.serverChan.send(
  '标题',
  'Markdown 内容',
  { ... } // 可选参数
);

// 发送库存预警
await notificationService.sendLowStockAlert(product, stockCount, threshold);
```

### 企业微信通知

```javascript
// 发送 Markdown 消息
await notificationService.weCom.sendMarkdown('### 标题\n内容');

// 发送库存预警
await notificationService.sendLowStockAlert(product, stockCount, threshold);
```

---

## 工作流程

```
启动服务器
    ↓
检查配置 (INVENTORY_CHECK_INTERVAL > 0)
    ↓
启动定时任务 (每 N 秒检查一次)
    ↓
    ┌─────────────────────────┐
    │  检查所有上架产品库存    │
    └─────────────────────────┘
              ↓
    ┌─────────────────────────┐
    │  筛选低库存产品          │
    │  (stock <= threshold)   │
    └─────────────────────────┘
              ↓
    ┌─────────────────────────┐
    │  检查 Redis 冷却状态    │
    │  (防止重复通知)          │
    └─────────────────────────┘
              ↓
         有新预警?
         ↙     ↘
       是         否
       ↓          ↓
  发送通知     跳过
  (多渠道)       ↓
       ↓      下次检查
  设置冷却
  (24小时)
       ↓
    记录日志
```

---

## 配置示例

### 开发环境

```env
INVENTORY_ALERT_THRESHOLD=5
INVENTORY_ADMIN_EMAIL=dev@localhost
INVENTORY_CHECK_INTERVAL=300  # 5分钟检查一次
```

### 生产环境

```env
INVENTORY_ALERT_THRESHOLD=20
INVENTORY_ADMIN_EMAIL=admin@yourstore.com
INVENTORY_CHECK_INTERVAL=3600  # 1小时检查一次
SERVERCHAN_SEND_KEY=SCT123456xxxxx
```

### 禁用自动监控

```env
INVENTORY_CHECK_INTERVAL=0  # 或者不设置此变量
```

---

## 故障排查

### 预警未发送

1. **检查配置**
   ```bash
   # 确认环境变量已设置
   echo $INVENTORY_ALERT_THRESHOLD
   echo $INVENTORY_ADMIN_EMAIL
   ```

2. **检查日志**
   ```
   [Inventory] Starting stock check...
   [Inventory] Found 2 low stock products
   [Inventory] Skipping alert for product 1 (cooldown period)
   ```

3. **检查冷却状态**
   ```javascript
   // 手动重置冷却
   await inventoryService.resetAlertCooldown(productId);
   ```

### 邮件未送达

1. 检查 SMTP 配置
2. 查看邮件服务日志
3. 检查管理员邮箱地址

### 微信通知未收到

1. 确认 Server酱 SendKey 正确
2. 检查 Server酱 服务状态
3. 查看服务日志

---

## 最佳实践

### 1. 合理设置阈值

根据产品销售速度设置合适的预警阈值：

- 热门产品: 较高阈值 (50-100)
- 普通产品: 中等阈值 (20-50)
- 冷门产品: 较低阈值 (10-20)

### 2. 多渠道通知

建议同时配置邮件和微信通知，确保不错过预警。

### 3. 定期检查

生产环境建议每 1-2 小时检查一次，避免频繁检查增加数据库负担。

### 4. 监控日志

定期查看库存检查日志，了解产品销售趋势。

### 5. 及时补货

收到预警后应尽快补充密钥，避免影响销售。

---

## 未来扩展

计划中的功能：

- [ ] 支持按产品设置不同的预警阈值
- [ ] 添加钉钉机器人通知
- [ ] 发送库存趋势报表
- [ ] 预测库存耗尽时间
- [ ] 自动下架缺货产品

---

## 相关文件

```
backend/src/
├── services/
│   ├── inventory.service.js      # 库存监控服务
│   ├── notification.service.js   # 通知服务 (微信)
│   └── email.service.js          # 邮件服务
│
├── config/
│   └── env.js                    # 环境配置
│
└── app.js                        # 启动库存监控
```

---

## 总结

库存预警服务是保证虚拟产品持续销售的重要功能，通过自动监控和及时通知，帮助管理员避免因缺货导致的销售损失。配置简单，支持多种通知渠道，是系统运维的得力助手。
