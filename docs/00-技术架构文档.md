# 虚拟产品销售平台 - 技术架构文档

**版本:** 1.0
**日期:** 2025-10-16
**状态:** 已确认

---

## 1. 技术栈选型

### 1.1 前端技术栈

#### 用户前端 (Customer Frontend)
- **框架:** Next.js 14 (React 18+)
- **语言:** TypeScript
- **样式方案:** Tailwind CSS + shadcn/ui
- **状态管理:** React Context + SWR (数据获取)
- **国际化:** next-i18next
- **表单处理:** React Hook Form + Zod
- **HTTP客户端:** Axios
- **部署平台:** Vercel

**选型理由:**
- Next.js 提供 SSR/SSG，SEO 友好，全球加载速度快
- Vercel 全球 CDN 加速，部署简单
- TypeScript 提供类型安全，减少运行时错误
- Tailwind CSS 开发效率高，样式一致性好

#### 管理后台 (Admin Dashboard)
- **框架:** Next.js 14 (React 18+)
- **UI组件库:** Ant Design / shadcn/ui
- **图表库:** Recharts
- **其他:** 同用户前端技术栈

---

### 1.2 后端技术栈

- **运行时:** Node.js 20+ LTS
- **语言:** JavaScript/TypeScript
- **Web框架:** Fastify 4.x
- **ORM:** Prisma
- **数据库:** PostgreSQL 15+
- **缓存/会话:** Redis 7+
- **身份验证:** JWT (jsonwebtoken)
- **加密:** Node.js crypto + bcrypt
- **参数验证:** Zod / Fastify Schema
- **日志:** Pino (Fastify 内置)

**选型理由:**
- Fastify 性能优异，比 Express 快约 65%
- Prisma 类型安全，开发体验好，自动生成迁移
- PostgreSQL 事务支持完善，适合订单系统
- Redis 用于验证码缓存和会话管理

---

### 1.3 第三方服务

| 服务类型 | 选型方案 | 用途 |
|---------|---------|------|
| **支付** | 支付宝开放平台 + 微信支付 | 订单支付 |
| **邮件** | SendGrid / Resend | 订单确认、验证码 |
| **IP地理位置** | MaxMind GeoLite2 / ip-api.com | 价格本地化 |
| **微信通知** | Server酱 (ServerChan) | 库存预警 |
| **文件存储** | AWS S3 / Cloudinary | 产品图片上传 |

---

## 2. 系统架构设计

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────┐
│                    客户端层 (Client)                      │
├──────────────────────┬──────────────────────────────────┤
│  用户前端 (Next.js)   │   管理后台 (Next.js)              │
│  - 商品展示页         │   - 仪表盘                        │
│  - 支付流程          │   - 产品管理                       │
│  - 订单查询          │   - 密钥管理                       │
│                      │   - 订单管理                       │
└──────────┬───────────┴──────────────┬───────────────────┘
           │                          │
           │        HTTPS/TLS         │
           │                          │
┌──────────▼──────────────────────────▼───────────────────┐
│                  API 网关 (Fastify)                       │
│  ┌─────────────────────────────────────────────────┐    │
│  │            路由层 (Routes)                        │    │
│  ├─────────────────────────────────────────────────┤    │
│  │  /api/public/*  │  /api/admin/*                 │    │
│  └─────────┬───────────────────┬───────────────────┘    │
│            │                   │                         │
│  ┌─────────▼───────────────────▼───────────────────┐    │
│  │        中间件层 (Middleware)                      │    │
│  │  - CORS / Helmet (安全)                          │    │
│  │  - Rate Limiting (限流)                          │    │
│  │  - JWT 认证 (管理员)                              │    │
│  │  - 请求日志 (Pino)                               │    │
│  └─────────┬───────────────────────────────────────┘    │
│            │                                            │
│  ┌─────────▼───────────────────────────────────────┐    │
│  │         业务逻辑层 (Services)                      │    │
│  │  - ProductService   - OrderService              │    │
│  │  - PaymentService   - LicenseService            │    │
│  │  - EmailService     - NotificationService       │    │
│  │  - GeoService       - AuthService               │    │
│  └─────────┬───────────────────────────────────────┘    │
│            │                                            │
│  ┌─────────▼───────────────────────────────────────┐    │
│  │        数据访问层 (Data Access)                    │    │
│  │            Prisma ORM                             │    │
│  └─────────┬───────────────────────────────────────┘    │
└────────────┼────────────────────────────────────────────┘
             │
    ┌────────▼────────┐          ┌─────────────────┐
    │   PostgreSQL    │          │     Redis       │
    │   (主数据库)     │          │  (缓存/会话)     │
    └─────────────────┘          └─────────────────┘

         ┌─────────────────────────────────────┐
         │        外部服务 (External)            │
         ├───────────────┬─────────────────────┤
         │ 支付宝/微信    │  SendGrid  │ Server酱│
         └───────────────┴─────────────────────┘
```

### 2.2 数据流设计

#### 2.2.1 购买流程
```
用户 → 查看产品 (根据IP显示价格)
    → 点击购买
    → 输入邮箱
    → 选择支付方式
    → 跳转支付页面 (支付宝/微信)
    → 支付成功回调
    → 后端分配密钥 + 发送邮件
    → 前端显示密钥
```

#### 2.2.2 订单查询流程
```
用户 → 输入邮箱
    → 后端生成验证码 + 存入Redis
    → 发送邮件
    → 用户输入验证码
    → 后端验证
    → 返回该邮箱的所有订单
```

---

## 3. 核心模块设计

### 3.1 认证与授权

| 角色 | 认证方式 | 权限范围 |
|-----|---------|---------|
| **普通用户** | 无需认证 (游客模式) | 浏览商品、购买、查询自己的订单 |
| **管理员** | JWT Token | 全部后台管理功能 |

**实现细节:**
- 用户无需注册，通过邮箱验证码验证身份
- 管理员登录后签发 JWT，有效期 24 小时
- 所有 `/api/admin/*` 接口需要 JWT 验证

---

### 3.2 安全策略

#### 3.2.1 数据安全
- **密钥加密:** 使用 AES-256-GCM 加密存储
- **密码存储:** bcrypt 哈希 (管理员密码)
- **敏感配置:** 使用环境变量，不提交到代码库

#### 3.2.2 传输安全
- 强制 HTTPS
- 使用 Helmet 设置安全头
- CORS 限制只允许前端域名

#### 3.2.3 应用安全
- SQL 注入防护: Prisma 参数化查询
- XSS 防护: 前端输入转义
- CSRF 防护: SameSite Cookie
- Rate Limiting: 限制 API 请求频率

#### 3.2.4 支付安全
- 服务端验证支付签名
- 双重检查订单金额
- 使用数据库事务确保一致性

---

## 4. 项目目录结构

```
project-root/
├── docs/                          # 📄 文档目录
│   ├── 00-技术架构文档.md
│   ├── 01-数据库设计文档.md
│   ├── 02-API接口文档.md
│   ├── 03-前端组件设计文档.md
│   └── 04-部署运维文档.md
│
├── backend/                       # 🔧 后端服务
│   ├── prisma/
│   │   ├── schema.prisma         # 数据库模型定义
│   │   └── migrations/           # 数据库迁移文件
│   ├── src/
│   │   ├── config/               # 配置文件
│   │   │   ├── database.js
│   │   │   ├── payment.js
│   │   │   └── email.js
│   │   ├── models/               # 数据模型 (Prisma 生成)
│   │   ├── routes/               # 路由
│   │   │   ├── public/           # 公开路由
│   │   │   │   ├── products.js
│   │   │   │   ├── orders.js
│   │   │   │   └── payments.js
│   │   │   └── admin/            # 管理路由
│   │   │       ├── dashboard.js
│   │   │       ├── products.js
│   │   │       ├── licenses.js
│   │   │       ├── orders.js
│   │   │       └── settings.js
│   │   ├── services/             # 业务逻辑
│   │   │   ├── product.service.js
│   │   │   ├── order.service.js
│   │   │   ├── payment.service.js
│   │   │   ├── license.service.js
│   │   │   ├── email.service.js
│   │   │   ├── notification.service.js
│   │   │   ├── geo.service.js
│   │   │   └── auth.service.js
│   │   ├── middleware/           # 中间件
│   │   │   ├── auth.js
│   │   │   ├── errorHandler.js
│   │   │   └── rateLimit.js
│   │   ├── utils/                # 工具函数
│   │   │   ├── encryption.js
│   │   │   ├── validation.js
│   │   │   └── logger.js
│   │   └── app.js                # 应用入口
│   ├── .env.example              # 环境变量示例
│   ├── package.json
│   └── README.md
│
├── frontend/                      # 🎨 用户前端
│   ├── components/
│   │   ├── common/               # 通用组件
│   │   │   ├── Button.tsx
│   │   │   ├── Input.tsx
│   │   │   ├── Modal.tsx
│   │   │   └── Loading.tsx
│   │   └── features/             # 功能组件
│   │       ├── ProductCard.tsx
│   │       ├── PaymentModal.tsx
│   │       └── OrderList.tsx
│   ├── pages/
│   │   ├── _app.tsx
│   │   ├── index.tsx             # 商品展示页
│   │   ├── checkout.tsx          # 支付页
│   │   └── orders/
│   │       └── lookup.tsx        # 订单查询
│   ├── public/
│   │   └── locales/              # 多语言文件
│   │       ├── zh-CN/
│   │       │   └── common.json
│   │       └── en-US/
│   │           └── common.json
│   ├── utils/
│   │   ├── api.ts                # API 调用封装
│   │   └── helpers.ts
│   ├── next.config.js
│   ├── package.json
│   └── tsconfig.json
│
└── admin/                         # 🔐 管理后台
    ├── components/
    ├── pages/
    │   ├── login.tsx
    │   ├── dashboard.tsx
    │   ├── products/
    │   ├── licenses/
    │   ├── orders/
    │   └── settings.tsx
    ├── package.json
    └── tsconfig.json
```

---

## 5. 开发环境要求

### 5.1 本地开发环境
- **Node.js:** >= 20.0.0
- **npm/pnpm:** 最新版本
- **PostgreSQL:** >= 15.0
- **Redis:** >= 7.0
- **IDE:** VS Code (推荐插件: Prisma, ESLint, Tailwind CSS IntelliSense)

### 5.2 环境变量配置

#### 后端 (.env)
```bash
# 数据库
DATABASE_URL="postgresql://user:password@localhost:5432/license_store"

# Redis
REDIS_URL="redis://localhost:6379"

# JWT
JWT_SECRET="your-super-secret-key"

# 加密密钥
ENCRYPTION_KEY="32-byte-encryption-key"

# 支付宝
ALIPAY_APP_ID="your-app-id"
ALIPAY_PRIVATE_KEY="your-private-key"
ALIPAY_PUBLIC_KEY="alipay-public-key"

# 微信支付
WECHAT_APP_ID="your-app-id"
WECHAT_MCH_ID="your-mch-id"
WECHAT_API_KEY="your-api-key"

# 邮件服务
SENDGRID_API_KEY="your-api-key"
EMAIL_FROM="noreply@yourstore.com"

# 微信通知
SERVERCHAN_KEY="your-serverchan-key"

# IP 地理位置
IPAPI_KEY="your-ipapi-key" # 可选
```

---

## 6. 性能目标

| 指标 | 目标值 |
|-----|-------|
| 首页加载时间 | < 2s (全球平均) |
| API 响应时间 | < 200ms (P95) |
| 支付成功到密钥分发 | < 3s |
| 系统可用性 | 99.9% |
| 并发订单处理能力 | 100 TPS |

---

## 7. 技术债务与未来优化

### 7.1 短期优化 (MVP 阶段)
- [ ] 基础功能实现
- [ ] 单元测试覆盖核心业务逻辑
- [ ] 基本的监控和日志

### 7.2 中期优化 (运营阶段)
- [ ] 引入消息队列 (Bull/BullMQ) 处理邮件和通知
- [ ] 添加 API 缓存层
- [ ] 完善监控告警 (Sentry)
- [ ] 性能优化和压力测试

### 7.3 长期优化 (扩展阶段)
- [ ] 微服务拆分 (如需要)
- [ ] 支持更多支付方式
- [ ] 多语言扩展
- [ ] 移动端 App

---

**文档维护:** 本文档随项目演进持续更新
**最后更新:** 2025-10-16
