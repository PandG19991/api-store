# 管理员认证系统文档

## 概述

管理员认证系统基于 JWT (JSON Web Token) 实现，提供安全的身份验证和权限管理功能。

---

## 核心功能

### 1. 身份认证
- ✅ 用户名密码登录
- ✅ JWT Token 生成与验证
- ✅ Token 刷新机制
- ✅ 登出功能

### 2. 权限管理
- ✅ 双层权限：普通管理员（admin）和超级管理员（super_admin）
- ✅ 账号启用/禁用功能
- ✅ 细粒度的 API 权限控制

### 3. 密码管理
- ✅ Bcrypt 加密存储
- ✅ 密码复杂度验证
- ✅ 修改密码功能
- ✅ 防暴力破解

---

## 技术实现

### 数据库模型

```prisma
model AdminUser {
  id           Int       @id @default(autoincrement())
  username     String    @unique @db.VarChar(50)
  passwordHash String    @map("password_hash") @db.VarChar(255)
  email        String?   @unique @db.VarChar(255)
  role         String    @default("admin") @db.VarChar(20) // admin, super_admin
  isActive     Boolean   @default(true) @map("is_active")
  lastLoginAt  DateTime? @map("last_login_at") @db.Timestamptz(6)
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([username])
  @@map("admin_users")
}
```

### JWT Token 结构

```json
{
  "adminId": 1,
  "username": "admin",
  "role": "super_admin",
  "iat": 1676534400,
  "exp": 1676620800
}
```

### 安全特性

1. **密码加密**
   - 使用 Bcrypt（Salt Rounds: 10）
   - 单向哈希，无法逆向破解

2. **Token 安全**
   - HMAC-SHA256 签名
   - 可配置过期时间（默认 24 小时）
   - 支持刷新机制

3. **防护机制**
   - 账号禁用检查
   - Token 过期验证
   - 权限级别控制

---

## API 接口

### 1. 管理员登录

**端点**: `POST /api/admin/auth/login`

**请求体**:
```json
{
  "username": "admin",
  "password": "your-password"
}
```

**响应**:
```json
{
  "success": true,
  "message": "Login successful",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "admin": {
      "id": 1,
      "username": "admin",
      "email": "admin@example.com",
      "role": "super_admin",
      "isActive": true,
      "lastLoginAt": "2025-10-16T10:30:00.000Z",
      "createdAt": "2025-01-01T00:00:00.000Z"
    }
  }
}
```

### 2. 注册管理员

**端点**: `POST /api/admin/auth/register`
**权限**: 需要超级管理员

**请求头**:
```
Authorization: Bearer <token>
```

**请求体**:
```json
{
  "username": "newadmin",
  "password": "securePassword123",
  "email": "newadmin@example.com",
  "role": "admin"
}
```

**响应**:
```json
{
  "success": true,
  "message": "Admin created successfully",
  "data": {
    "admin": {
      "id": 2,
      "username": "newadmin",
      "email": "newadmin@example.com",
      "role": "admin",
      "isActive": true,
      "createdAt": "2025-10-16T10:35:00.000Z"
    }
  }
}
```

### 3. 获取当前用户信息

**端点**: `GET /api/admin/auth/me`
**权限**: 需要认证

**请求头**:
```
Authorization: Bearer <token>
```

**响应**:
```json
{
  "success": true,
  "data": {
    "admin": {
      "id": 1,
      "username": "admin",
      "email": "admin@example.com",
      "role": "super_admin",
      "isActive": true,
      "lastLoginAt": "2025-10-16T10:30:00.000Z",
      "createdAt": "2025-01-01T00:00:00.000Z"
    }
  }
}
```

### 4. 修改密码

**端点**: `POST /api/admin/auth/change-password`
**权限**: 需要认证

**请求头**:
```
Authorization: Bearer <token>
```

**请求体**:
```json
{
  "oldPassword": "oldPassword123",
  "newPassword": "newPassword456"
}
```

**响应**:
```json
{
  "success": true,
  "message": "Password changed successfully"
}
```

### 5. 刷新 Token

**端点**: `POST /api/admin/auth/refresh`
**权限**: 需要认证

**请求头**:
```
Authorization: Bearer <token>
```

**响应**:
```json
{
  "success": true,
  "message": "Token refreshed",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }
}
```

### 6. 登出

**端点**: `POST /api/admin/auth/logout`
**权限**: 需要认证

**请求头**:
```
Authorization: Bearer <token>
```

**响应**:
```json
{
  "success": true,
  "message": "Logged out successfully"
}
```

---

## 中间件使用

### 1. authenticate

验证 JWT Token 并获取管理员信息。

```javascript
import { authenticate } from './middleware/auth.js';

fastify.get('/protected', {
  preHandler: [authenticate],
}, async (request, reply) => {
  // request.admin 包含管理员信息
  return { admin: request.admin };
});
```

### 2. requireAdmin

确保用户是管理员（admin 或 super_admin）。

```javascript
import { requireAdmin } from './middleware/auth.js';

fastify.get('/admin-only', {
  preHandler: [requireAdmin],
}, async (request, reply) => {
  // 只有管理员可以访问
  return { message: 'Admin access granted' };
});
```

### 3. requireSuperAdmin

确保用户是超级管理员。

```javascript
import { requireSuperAdmin } from './middleware/auth.js';

fastify.delete('/critical-operation', {
  preHandler: [requireSuperAdmin],
}, async (request, reply) => {
  // 只有超级管理员可以执行
  return { message: 'Super admin access granted' };
});
```

### 4. optionalAuth

可选认证，不强制要求登录。

```javascript
import { optionalAuth } from './middleware/auth.js';

fastify.get('/public-or-private', {
  preHandler: [optionalAuth],
}, async (request, reply) => {
  if (request.admin) {
    return { message: 'Logged in', admin: request.admin };
  }
  return { message: 'Anonymous access' };
});
```

---

## 初始化管理员

### 方法 1: 使用初始化脚本

```bash
cd backend
node scripts/init-admin.js
```

按提示输入：
- 用户名
- 密码
- 邮箱（可选）

### 方法 2: 直接操作数据库

```sql
INSERT INTO admin_users (username, password_hash, email, role, is_active, created_at)
VALUES (
  'admin',
  '$2b$10$YOUR_HASHED_PASSWORD',
  'admin@example.com',
  'super_admin',
  true,
  NOW()
);
```

生成密码哈希：
```javascript
import bcrypt from 'bcrypt';
const hash = await bcrypt.hash('your-password', 10);
console.log(hash);
```

---

## 环境配置

在 `.env` 文件中配置：

```env
# JWT 配置
JWT_SECRET="your-super-secret-jwt-key-change-this-in-production"
JWT_EXPIRES_IN="24h"
```

**注意**：
- JWT_SECRET 必须是强密码（建议 32 字符以上）
- 可使用 `openssl rand -base64 32` 生成

---

## 安全最佳实践

### 1. JWT Secret 管理
- ✅ 使用强随机密钥
- ✅ 定期轮换密钥
- ✅ 不提交到版本控制

### 2. 密码策略
- ✅ 最少 6 个字符
- ✅ Bcrypt 加密存储
- ✅ 建议包含大小写、数字、特殊字符

### 3. Token 管理
- ✅ 设置合理的过期时间
- ✅ HTTPS 传输
- ✅ 客户端安全存储（不用 localStorage）

### 4. 权限控制
- ✅ 最小权限原则
- ✅ 定期审计管理员账号
- ✅ 及时禁用离职账号

---

## 错误码

| 错误码 | HTTP 状态 | 说明 |
|-------|----------|------|
| UNAUTHORIZED | 401 | Token 无效或已过期 |
| FORBIDDEN | 403 | 权限不足或账号被禁用 |
| BAD_REQUEST | 400 | 请求参数错误 |

---

## 测试示例

### 使用 cURL

**登录**:
```bash
curl -X POST http://localhost:3000/api/admin/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "your-password"
  }'
```

**访问受保护接口**:
```bash
TOKEN="your-jwt-token"

curl -X GET http://localhost:3000/api/admin/auth/me \
  -H "Authorization: Bearer $TOKEN"
```

### 使用 Postman

1. 发送登录请求获取 token
2. 在 Authorization 选项卡选择 "Bearer Token"
3. 粘贴 token
4. 发送请求

---

## 故障排查

### 1. Token 验证失败

**问题**: `Invalid or expired token`

**解决**:
- 检查 JWT_SECRET 是否正确
- 确认 token 格式：`Bearer <token>`
- 检查 token 是否过期

### 2. 登录失败

**问题**: `Invalid username or password`

**解决**:
- 确认用户名和密码正确
- 检查管理员账号是否存在
- 确认账号是否被禁用

### 3. 权限不足

**问题**: `Super admin access required`

**解决**:
- 确认账号角色是否为 super_admin
- 检查 token 中的 role 字段

---

## 相关文件

```
backend/src/
├── services/
│   └── admin.service.js          # 管理员服务
│
├── middleware/
│   └── auth.js                    # JWT 认证中间件
│
├── routes/
│   └── admin/
│       └── auth.js                # 认证路由
│
└── scripts/
    └── init-admin.js              # 初始化管理员脚本
```

---

## 总结

管理员认证系统提供了完整的身份验证和权限管理功能，采用业界标准的 JWT + Bcrypt 方案，安全可靠。所有受保护的 API 都需要经过认证，确保系统安全。
