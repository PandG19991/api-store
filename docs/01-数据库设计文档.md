# 数据库设计文档

**版本:** 1.0
**日期:** 2025-10-16
**数据库:** PostgreSQL 15+

---

## 1. 数据库设计原则

### 1.1 设计目标
- **数据一致性:** 使用事务确保订单和库存的强一致性
- **查询性能:** 合理设置索引，优化常用查询
- **可扩展性:** 预留扩展字段，支持未来功能
- **安全性:** 敏感数据加密存储

### 1.2 命名规范
- 表名: 复数形式，帕斯卡命名 (如 `Products`, `Orders`)
- 字段名: 蛇形命名 (如 `created_at`, `customer_email`)
- 索引名: `idx_表名_字段名`
- 外键名: `fk_表名_引用表名`

---

## 2. 核心数据表设计

### 2.1 Products (产品表)

**用途:** 存储虚拟产品的基本信息

| 字段名 | 类型 | 约束 | 说明 |
|-------|------|------|------|
| id | SERIAL | PRIMARY KEY | 产品ID |
| name | VARCHAR(255) | NOT NULL | 产品名称 |
| slug | VARCHAR(255) | UNIQUE, NOT NULL | URL友好的标识符 |
| description_zh | TEXT | | 中文描述 |
| description_en | TEXT | | 英文描述 |
| image_url | VARCHAR(500) | | 产品主图URL |
| video_url | VARCHAR(500) | | 产品视频URL (可选) |
| status | VARCHAR(20) | DEFAULT 'active' | 状态: active/inactive |
| sort_order | INTEGER | DEFAULT 0 | 显示排序 |
| created_at | TIMESTAMP WITH TIME ZONE | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP WITH TIME ZONE | DEFAULT CURRENT_TIMESTAMP | 更新时间 |

**索引:**
```sql
CREATE INDEX idx_products_status ON Products(status);
CREATE INDEX idx_products_slug ON Products(slug);
```

**示例数据:**
```sql
INSERT INTO Products (name, slug, description_zh, description_en, image_url) VALUES
('Windows 11 Pro', 'windows-11-pro',
 'Windows 11 专业版激活密钥，支持永久激活',
 'Windows 11 Pro activation key, lifetime license',
 'https://cdn.example.com/windows11.jpg');
```

---

### 2.2 Prices (价格表)

**用途:** 存储不同区域的产品价格

| 字段名 | 类型 | 约束 | 说明 |
|-------|------|------|------|
| id | SERIAL | PRIMARY KEY | 价格ID |
| product_id | INTEGER | NOT NULL, FK → Products(id) | 产品ID |
| country_code | VARCHAR(2) | NOT NULL | 国家代码 (ISO 3166-1) |
| currency | VARCHAR(3) | NOT NULL | 货币代码 (ISO 4217) |
| amount | NUMERIC(10, 2) | NOT NULL | 价格金额 |
| original_amount | NUMERIC(10, 2) | | 原价 (用于显示折扣) |
| is_default | BOOLEAN | DEFAULT false | 是否为默认价格 |
| created_at | TIMESTAMP WITH TIME ZONE | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP WITH TIME ZONE | DEFAULT CURRENT_TIMESTAMP | 更新时间 |

**约束:**
```sql
CONSTRAINT unique_product_country UNIQUE(product_id, country_code)
```

**索引:**
```sql
CREATE INDEX idx_prices_product_id ON Prices(product_id);
CREATE INDEX idx_prices_country_code ON Prices(country_code);
```

**示例数据:**
```sql
INSERT INTO Prices (product_id, country_code, currency, amount, is_default) VALUES
(1, 'CN', 'CNY', 99.00, false),
(1, 'US', 'USD', 15.00, true),
(1, 'JP', 'JPY', 2000.00, false);
```

**设计说明:**
- `is_default = true` 的价格作为兜底价格，当用户IP无法匹配时使用
- 支持设置原价，用于显示促销折扣

---

### 2.3 LicenseKeys (密钥表)

**用途:** 存储产品密钥及其状态

| 字段名 | 类型 | 约束 | 说明 |
|-------|------|------|------|
| id | SERIAL | PRIMARY KEY | 密钥ID |
| product_id | INTEGER | NOT NULL, FK → Products(id) | 所属产品ID |
| key_value_encrypted | TEXT | NOT NULL | 加密后的密钥 |
| status | VARCHAR(20) | NOT NULL, DEFAULT 'available' | 状态: available/sold/revoked |
| order_id | INTEGER | FK → Orders(id) | 关联的订单ID (售出后) |
| created_at | TIMESTAMP WITH TIME ZONE | DEFAULT CURRENT_TIMESTAMP | 导入时间 |
| sold_at | TIMESTAMP WITH TIME ZONE | | 售出时间 |
| revoked_at | TIMESTAMP WITH TIME ZONE | | 作废时间 |
| revoke_reason | TEXT | | 作废原因 |

**索引:**
```sql
CREATE INDEX idx_license_product_status ON LicenseKeys(product_id, status);
CREATE INDEX idx_license_order_id ON LicenseKeys(order_id);
```

**设计说明:**
- `key_value_encrypted` 使用 AES-256-GCM 加密存储
- 密钥状态流转: available → sold (正常售出) 或 available → revoked (作废)
- 售出的密钥不可再次使用

**加密示例 (伪代码):**
```javascript
// 加密
const encrypted = encrypt('XXXXX-XXXXX-XXXXX', process.env.ENCRYPTION_KEY);
// 解密
const decrypted = decrypt(encrypted, process.env.ENCRYPTION_KEY);
```

---

### 2.4 Orders (订单表)

**用途:** 存储订单主信息

| 字段名 | 类型 | 约束 | 说明 |
|-------|------|------|------|
| id | SERIAL | PRIMARY KEY | 订单ID |
| order_no | VARCHAR(32) | UNIQUE, NOT NULL | 订单号 (唯一) |
| customer_email | VARCHAR(255) | NOT NULL | 客户邮箱 |
| total_amount | NUMERIC(10, 2) | NOT NULL | 订单总金额 |
| currency | VARCHAR(3) | NOT NULL | 货币代码 |
| status | VARCHAR(20) | NOT NULL, DEFAULT 'pending' | 订单状态 |
| payment_method | VARCHAR(20) | | 支付方式: alipay/wechat |
| payment_txn_id | VARCHAR(255) | | 支付平台交易号 |
| country_code | VARCHAR(2) | | 用户所在国家 |
| ip_address | VARCHAR(45) | | 用户IP地址 |
| user_agent | TEXT | | 用户UA |
| created_at | TIMESTAMP WITH TIME ZONE | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| paid_at | TIMESTAMP WITH TIME ZONE | | 支付完成时间 |
| completed_at | TIMESTAMP WITH TIME ZONE | | 订单完成时间 |

**订单状态流转:**
- `pending`: 待支付
- `paid`: 已支付，待处理
- `completed`: 已完成 (密钥已分配)
- `failed`: 失败
- `refunded`: 已退款

**索引:**
```sql
CREATE INDEX idx_orders_email ON Orders(customer_email);
CREATE INDEX idx_orders_order_no ON Orders(order_no);
CREATE INDEX idx_orders_status ON Orders(status);
CREATE INDEX idx_orders_created_at ON Orders(created_at DESC);
CREATE INDEX idx_orders_payment_txn_id ON Orders(payment_txn_id);
```

**订单号生成规则:**
```
格式: ORD{YYYYMMDD}{6位随机数字}
示例: ORD202510160012345
```

---

### 2.5 OrderItems (订单项表)

**用途:** 存储订单中的商品明细 (支持未来一单多品)

| 字段名 | 类型 | 约束 | 说明 |
|-------|------|------|------|
| id | SERIAL | PRIMARY KEY | 订单项ID |
| order_id | INTEGER | NOT NULL, FK → Orders(id) | 订单ID |
| product_id | INTEGER | NOT NULL, FK → Products(id) | 产品ID |
| product_name | VARCHAR(255) | NOT NULL | 产品名称快照 |
| price_id | INTEGER | FK → Prices(id) | 价格ID |
| unit_price | NUMERIC(10, 2) | NOT NULL | 单价快照 |
| quantity | INTEGER | NOT NULL, DEFAULT 1 | 数量 |
| subtotal | NUMERIC(10, 2) | NOT NULL | 小计 |
| license_key_id | INTEGER | FK → LicenseKeys(id) | 分配的密钥ID |

**索引:**
```sql
CREATE INDEX idx_order_items_order_id ON OrderItems(order_id);
CREATE INDEX idx_order_items_license_key_id ON OrderItems(license_key_id);
```

**设计说明:**
- 存储快照数据 (`product_name`, `unit_price`)，避免后续修改产品信息影响历史订单
- 当前版本 `quantity` 固定为 1，为未来扩展预留

---

### 2.6 VerificationCodes (验证码表)

**用途:** 存储邮箱验证码 (订单查询)

| 字段名 | 类型 | 约束 | 说明 |
|-------|------|------|------|
| id | SERIAL | PRIMARY KEY | ID |
| email | VARCHAR(255) | NOT NULL | 邮箱地址 |
| code | VARCHAR(6) | NOT NULL | 6位数字验证码 |
| purpose | VARCHAR(20) | NOT NULL | 用途: order_lookup |
| expires_at | TIMESTAMP WITH TIME ZONE | NOT NULL | 过期时间 (5分钟) |
| used_at | TIMESTAMP WITH TIME ZONE | | 使用时间 |
| created_at | TIMESTAMP WITH TIME ZONE | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

**索引:**
```sql
CREATE INDEX idx_verification_email_code ON VerificationCodes(email, code, purpose);
CREATE INDEX idx_verification_expires_at ON VerificationCodes(expires_at);
```

**设计说明:**
- 验证码有效期 5 分钟
- 使用后标记 `used_at`，不可重复使用
- 定期清理过期数据 (定时任务)

---

### 2.7 AdminUsers (管理员表)

**用途:** 存储管理员账号

| 字段名 | 类型 | 约束 | 说明 |
|-------|------|------|------|
| id | SERIAL | PRIMARY KEY | 管理员ID |
| username | VARCHAR(50) | UNIQUE, NOT NULL | 用户名 |
| password_hash | VARCHAR(255) | NOT NULL | bcrypt 哈希密码 |
| email | VARCHAR(255) | UNIQUE | 邮箱 |
| role | VARCHAR(20) | DEFAULT 'admin' | 角色: admin/super_admin |
| is_active | BOOLEAN | DEFAULT true | 是否启用 |
| last_login_at | TIMESTAMP WITH TIME ZONE | | 最后登录时间 |
| created_at | TIMESTAMP WITH TIME ZONE | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

**索引:**
```sql
CREATE UNIQUE INDEX idx_admin_username ON AdminUsers(username);
```

**初始管理员:**
```sql
-- 密码: admin123 (示例，实际部署需修改)
INSERT INTO AdminUsers (username, password_hash, role) VALUES
('admin', '$2b$10$...', 'super_admin');
```

---

### 2.8 SystemSettings (系统配置表)

**用途:** 存储系统配置 (键值对)

| 字段名 | 类型 | 约束 | 说明 |
|-------|------|------|------|
| id | SERIAL | PRIMARY KEY | 配置ID |
| key | VARCHAR(100) | UNIQUE, NOT NULL | 配置键 |
| value | TEXT | | 配置值 (JSON 格式) |
| description | TEXT | | 配置说明 |
| updated_at | TIMESTAMP WITH TIME ZONE | DEFAULT CURRENT_TIMESTAMP | 更新时间 |

**配置项示例:**
```sql
INSERT INTO SystemSettings (key, value, description) VALUES
('stock_alert_threshold', '50', '库存预警阈值'),
('payment_alipay_appid', 'xxxxx', '支付宝 AppID'),
('payment_wechat_mchid', 'xxxxx', '微信商户号'),
('notification_serverchan_key', 'xxxxx', 'Server酱推送Key'),
('email_sendgrid_apikey', 'xxxxx', 'SendGrid API Key');
```

---

## 3. 数据库关系图 (ERD)

```
┌─────────────────┐
│    Products     │
│─────────────────│
│ id (PK)         │
│ name            │
│ slug            │
│ description_*   │
│ image_url       │
│ ...             │
└────────┬────────┘
         │
         │ 1:N
         │
    ┌────▼────────────┐          ┌─────────────────┐
    │     Prices      │          │  LicenseKeys    │
    │─────────────────│          │─────────────────│
    │ id (PK)         │          │ id (PK)         │
    │ product_id (FK) │◄────┐    │ product_id (FK) │
    │ country_code    │     │    │ key_encrypted   │
    │ currency        │     │ 1:N│ status          │
    │ amount          │     │    │ order_id (FK)   │
    └─────────────────┘     │    └────────┬────────┘
                            │             │
                            │             │ N:1
                            │             │
    ┌─────────────────┐     │    ┌────────▼────────┐
    │  OrderItems     │     │    │     Orders      │
    │─────────────────│     │    │─────────────────│
    │ id (PK)         │     │    │ id (PK)         │
    │ order_id (FK)   │─────┼───►│ order_no (UK)   │
    │ product_id (FK) │     │    │ customer_email  │
    │ price_id (FK)   │─────┘    │ total_amount    │
    │ license_key_id  │◄─────────┤ status          │
    │ ...             │          │ ...             │
    └─────────────────┘          └─────────────────┘

    ┌─────────────────────┐      ┌──────────────────┐
    │ VerificationCodes   │      │   AdminUsers     │
    │─────────────────────│      │──────────────────│
    │ id (PK)             │      │ id (PK)          │
    │ email               │      │ username (UK)    │
    │ code                │      │ password_hash    │
    │ expires_at          │      │ role             │
    └─────────────────────┘      └──────────────────┘

    ┌─────────────────────┐
    │  SystemSettings     │
    │─────────────────────│
    │ id (PK)             │
    │ key (UK)            │
    │ value               │
    └─────────────────────┘
```

---

## 4. 关键业务逻辑的数据库操作

### 4.1 支付成功后的订单处理 (事务操作)

```sql
BEGIN;

-- 1. 更新订单状态
UPDATE Orders
SET status = 'paid', paid_at = CURRENT_TIMESTAMP
WHERE id = $1 AND status = 'pending';

-- 2. 锁定一个可用密钥
UPDATE LicenseKeys
SET status = 'sold',
    order_id = $1,
    sold_at = CURRENT_TIMESTAMP
WHERE id = (
    SELECT id FROM LicenseKeys
    WHERE product_id = $2 AND status = 'available'
    LIMIT 1
    FOR UPDATE SKIP LOCKED
)
RETURNING id, key_value_encrypted;

-- 3. 更新订单项
UPDATE OrderItems
SET license_key_id = $3
WHERE order_id = $1;

-- 4. 标记订单完成
UPDATE Orders
SET status = 'completed', completed_at = CURRENT_TIMESTAMP
WHERE id = $1;

COMMIT;
```

**关键点:**
- `FOR UPDATE SKIP LOCKED`: 避免多个并发请求锁定同一个密钥
- 使用事务确保订单和库存的一致性

---

### 4.2 库存查询

```sql
-- 查询某产品的库存统计
SELECT
    p.id,
    p.name,
    COUNT(CASE WHEN lk.status = 'available' THEN 1 END) as available_count,
    COUNT(CASE WHEN lk.status = 'sold' THEN 1 END) as sold_count,
    COUNT(*) as total_count
FROM Products p
LEFT JOIN LicenseKeys lk ON p.id = lk.product_id
WHERE p.id = $1
GROUP BY p.id, p.name;
```

---

### 4.3 订单查询 (验证码验证后)

```sql
-- 1. 验证验证码
SELECT * FROM VerificationCodes
WHERE email = $1
  AND code = $2
  AND purpose = 'order_lookup'
  AND expires_at > CURRENT_TIMESTAMP
  AND used_at IS NULL
LIMIT 1;

-- 2. 标记验证码已使用
UPDATE VerificationCodes
SET used_at = CURRENT_TIMESTAMP
WHERE id = $1;

-- 3. 查询该邮箱的所有订单
SELECT
    o.id,
    o.order_no,
    o.total_amount,
    o.currency,
    o.status,
    o.created_at,
    oi.product_name,
    lk.key_value_encrypted
FROM Orders o
LEFT JOIN OrderItems oi ON o.id = oi.order_id
LEFT JOIN LicenseKeys lk ON oi.license_key_id = lk.id
WHERE o.customer_email = $1
  AND o.status = 'completed'
ORDER BY o.created_at DESC;
```

---

## 5. 数据维护与优化

### 5.1 定期清理任务

```sql
-- 清理过期验证码 (每小时执行)
DELETE FROM VerificationCodes
WHERE expires_at < CURRENT_TIMESTAMP - INTERVAL '1 day';

-- 归档旧订单 (可选，根据业务需求)
-- 将 6 个月前的订单移至归档表
```

### 5.2 性能优化建议

1. **分区表 (Partitioning)**: 订单表按月分区 (如订单量大)
2. **只读副本**: 管理后台统计查询使用只读副本
3. **连接池**: 使用 pg-pool 管理数据库连接
4. **慢查询监控**: 定期分析 `pg_stat_statements`

---

## 6. 备份与恢复策略

### 6.1 备份方案
- **全量备份**: 每天凌晨 3 点自动备份
- **增量备份**: 使用 WAL 归档 (生产环境)
- **备份保留**: 最近 30 天

### 6.2 恢复测试
- 每月进行一次备份恢复演练

---

**文档维护:** 数据库结构变更需同步更新本文档
**最后更新:** 2025-10-16
