# 快速开始指南

本指南将帮助您在本地环境快速启动虚拟产品销售平台。

---

## 前置要求

在开始之前，请确保您的系统已安装：

- **Node.js** >= 20.0.0
- **PostgreSQL** >= 15.0
- **Redis** >= 7.0
- **npm** 或 **pnpm**

---

## 第一步：安装数据库

### 安装 PostgreSQL

**Windows:**
```bash
# 下载并安装 PostgreSQL
# https://www.postgresql.org/download/windows/

# 或使用 Chocolatey
choco install postgresql

# 启动服务
pg_ctl start
```

**macOS:**
```bash
brew install postgresql@15
brew services start postgresql@15
```

**Linux:**
```bash
sudo apt-get install postgresql-15
sudo systemctl start postgresql
```

### 创建数据库

```bash
# 登录 PostgreSQL
psql -U postgres

# 创建数据库
CREATE DATABASE license_store;

# 创建用户并授权 (可选)
CREATE USER licensestore_user WITH PASSWORD 'your_password';
GRANT ALL PRIVILEGES ON DATABASE license_store TO licensestore_user;

# 退出
\q
```

---

### 安装 Redis

**Windows:**
```bash
# 使用 WSL 或下载 Windows 版本
# https://github.com/microsoftarchive/redis/releases

# 或使用 Chocolatey
choco install redis-64
redis-server
```

**macOS:**
```bash
brew install redis
brew services start redis
```

**Linux:**
```bash
sudo apt-get install redis-server
sudo systemctl start redis
```

---

## 第二步：配置后端

### 1. 进入后端目录

```bash
cd backend
```

### 2. 安装依赖

```bash
npm install
```

### 3. 配置环境变量

```bash
# 复制环境变量示例文件
cp .env.example .env
```

### 4. 编辑 .env 文件

**Windows (使用记事本):**
```bash
notepad .env
```

**必须配置的环境变量:**

```env
# 数据库连接 (修改为您的实际配置)
DATABASE_URL="postgresql://postgres:your_password@localhost:5432/license_store"

# Redis 连接
REDIS_URL="redis://localhost:6379"

# JWT 密钥 (生成一个随机字符串)
JWT_SECRET="your-super-secret-jwt-key-change-this-in-production"

# 加密密钥 (运行下面的命令生成)
# node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
ENCRYPTION_KEY="your-32-byte-hex-key-here"
```

**生成加密密钥:**

```bash
# 方法1: 使用 Node.js
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"

# 方法2: 使用 OpenSSL
openssl rand -hex 32
```

将生成的密钥复制到 `.env` 文件的 `ENCRYPTION_KEY` 字段。

---

## 第三步：初始化数据库

### 1. 生成 Prisma Client

```bash
npm run db:generate
```

### 2. 运行数据库迁移

```bash
npm run db:migrate
```

这将创建所有必需的数据表。

### 3. (可选) 填充测试数据

```bash
npm run db:seed
```

---

## 第四步：启动开发服务器

```bash
npm run dev
```

您应该看到类似以下的输出:

```
✅ Database connected successfully
✅ Redis connected successfully

🚀 Server is running!
📍 Local:   http://localhost:3000
🌍 Network: http://0.0.0.0:3000
📝 Environment: development

Press Ctrl+C to stop the server
```

---

## 第五步：测试 API

### 方法 1: 使用浏览器

打开浏览器访问:
```
http://localhost:3000/health
```

您应该看到:
```json
{
  "success": true,
  "message": "Server is running",
  "timestamp": "2025-10-16T...",
  "uptime": 5.123
}
```

### 方法 2: 使用 cURL

```bash
curl http://localhost:3000/health
```

### 方法 3: 使用 Postman 或 Insomnia

导入以下请求:
- URL: `http://localhost:3000/health`
- Method: `GET`

---

## 常见问题排查

### 问题 1: 数据库连接失败

```
❌ Database connection error
```

**解决方案:**
1. 检查 PostgreSQL 是否正在运行
2. 验证 `.env` 中的 `DATABASE_URL` 是否正确
3. 测试数据库连接:
   ```bash
   psql -U postgres -d license_store
   ```

---

### 问题 2: Redis 连接失败

```
❌ Redis connection error
```

**解决方案:**
1. 检查 Redis 是否正在运行:
   ```bash
   redis-cli ping
   # 应该返回 PONG
   ```
2. 验证 `.env` 中的 `REDIS_URL`

---

### 问题 3: 端口已被占用

```
Error: listen EADDRINUSE: address already in use :::3000
```

**解决方案:**
1. 修改 `.env` 中的 `PORT`:
   ```env
   PORT=3001
   ```
2. 或关闭占用端口的程序

---

### 问题 4: Prisma 迁移失败

```
Error: P1001: Can't reach database server
```

**解决方案:**
1. 确保数据库服务正在运行
2. 检查数据库连接字符串
3. 重新运行迁移:
   ```bash
   npm run db:migrate
   ```

---

## 下一步

- [ ] 查看 [API 接口文档](./03-API接口文档.md)
- [ ] 实现业务逻辑服务
- [ ] 开发前端页面

---

## 有用的命令

### 数据库相关

```bash
# 查看数据库
npm run db:studio

# 重置数据库 (危险! 会删除所有数据)
npx prisma migrate reset

# 创建新的迁移
npx prisma migrate dev --name your_migration_name
```

### 开发相关

```bash
# 启动开发服务器 (自动重启)
npm run dev

# 启动生产服务器
npm start

# 查看日志
tail -f logs/app.log  # (如果配置了日志文件)
```

---

**祝您开发顺利！** 🚀
