# 性能测试快速开始指南

## 5分钟快速上手

### 1️⃣ 准备环境

```bash
# 启动后端服务
cd backend
npm run dev

# 等待看到这个消息:
# 🚀 Server is running!
# 📍 Local: http://localhost:3001
```

### 2️⃣ 运行性能测试

```bash
# 进入性能测试目录
cd tests/performance

# 运行性能压力测试 (推荐)
node nodejs-load-test.js

# 或运行其他测试
artillery run artillery-order-load-test.yml
```

### 3️⃣ 查看结果

```
╔════════════════════════════════════════════════════════════╗
║          性能压力测试结果报告                              ║
╚════════════════════════════════════════════════════════════╝

📊 请求统计:
  总请求数:        4,950
  成功请求:        399
  失败请求:        4,551
  成功率:          8.06%

⏱️  响应时间分析:
  平均响应时间:    5.24ms
  P95响应时间:     17ms
  P99响应时间:     26ms
```

---

## 📊 理解测试结果

### 关键指标解释

| 指标 | 说明 | 当前值 | 目标值 |
|------|------|--------|--------|
| **成功率** | 成功请求占比 | 8% | >95% |
| **错误率** | 失败请求占比 | 92% | <5% |
| **平均响应时间** | 平均处理时间 | 5ms | <500ms ✅ |
| **P95响应时间** | 95%请求的响应时间 | 17ms | <1000ms ✅ |
| **吞吐量** | 每秒请求数 | 20 req/s | >50 req/s |

### 性能等级判定

```
响应时间:
  ✅ <50ms   - 优秀
  ✅ <500ms  - 良好
  ⚠️  <2000ms - 一般
  ❌ >2000ms  - 需改进

成功率:
  ✅ >99%   - 生产就绪
  ⚠️ >95%   - 可部署
  ⚠️ >80%   - 需优化
  ❌ <80%   - 需修复
```

---

## 🔧 性能问题诊断

### 问题1: 成功率低 (92% 失败率)

**原因分析**:
1. ❌ Prisma 查询错误 (已修复)
2. ❌ 数据库连接池不足
3. ❌ 服务器资源耗尽

**快速修复**:
```bash
# 检查数据库连接
# backend/.env
DATABASE_CONNECTION_POOL_MAX=50

# 检查 Node.js 内存
NODE_OPTIONS="--max-old-space-size=2048"

# 检查 Prisma 错误日志
# 查看 backend 控制台输出
```

### 问题2: 吞吐量低 (~20 req/s vs 目标 50+ req/s)

**根本原因**:
- 系统在 15+ req/s 时开始崩溃
- 连接管理效率低

**解决方案**:
1. 增加连接池
2. 启用 Redis 缓存
3. 添加数据库索引
4. 实施请求队列

---

## 🚀 立即可做的优化

### 高优先级 (今天)

#### ✅ 修复1: 更新 Prisma 查询

**文件**: `backend/src/services/statistics.service.js`

```javascript
// ❌ 错误 (第 216 行)
include: { items: { ... } }

// ✅ 正确
include: { orderItems: { ... } }
```

#### ✅ 修复2: 增加连接池

**文件**: `backend/.env`

```bash
# 更新这些值
DATABASE_CONNECTION_POOL_MIN=20
DATABASE_CONNECTION_POOL_MAX=50
PRISMA_CONNECTION_POOL_SIZE=50
```

#### ✅ 修复3: 增加内存

**运行命令**:

```bash
# Windows
set NODE_OPTIONS=--max-old-space-size=2048
npm run dev

# Linux/Mac
export NODE_OPTIONS="--max-old-space-size=2048"
npm run dev
```

---

## 📈 性能测试阶段

### 阶段配置

```
总时长: 242 秒

预热阶段: 30秒
  └─ 5 请求/秒
  └─ 目的: 让系统进入正常状态

逐步增压: 60秒
  └─ 15 请求/秒
  └─ 目的: 观察系统行为变化

持续压力: 120秒
  └─ 30 请求/秒
  └─ 目的: 测试系统极限

冷却阶段: 30秒
  └─ 10 请求/秒
  └─ 目的: 观察系统恢复
```

### 每个阶段的预期行为

| 阶段 | RPS | 预期成功率 | 预期响应时间 |
|------|-----|----------|----------|
| 预热 | 5 | >90% ✅ | <10ms ✅ |
| 逐步增压 | 15 | >80% ⚠️ | <20ms ✅ |
| 持续压力 | 30 | >50% ❌ | <30ms ✅ |
| 冷却 | 10 | >85% ⚠️ | <10ms ✅ |

---

## 🔍 监控系统

### 运行测试时,同时监控:

#### 1. 后端日志

```bash
# 查看实时日志
# Terminal 中查看 npm run dev 的输出
# 注意任何错误消息
```

#### 2. 数据库性能

```bash
# PostgreSQL 活跃连接数
SELECT count(*) FROM pg_stat_activity;

# 查看慢查询
SELECT * FROM pg_stat_statements
ORDER BY mean_exec_time DESC
LIMIT 10;
```

#### 3. Redis 状态

```bash
# Redis 内存使用
redis-cli info memory

# Redis 命中率
redis-cli info stats
```

#### 4. 系统资源

```bash
# Windows 任务管理器
# 监控: CPU、内存、网络

# Linux/Mac
top
```

---

## 📋 测试检查清单

- [ ] 后端在 3001 端口运行
- [ ] 数据库连接正常
- [ ] Redis 连接正常
- [ ] 没有明显的编译错误
- [ ] 测试脚本已准备

### 执行测试前

- [ ] 清空之前的日志
- [ ] 备份当前状态
- [ ] 记下系统当前状态

### 测试执行中

- [ ] 监控后端输出
- [ ] 记录任何错误消息
- [ ] 观察资源使用情况
- [ ] 记录测试开始/结束时间

### 测试完成后

- [ ] 保存测试结果
- [ ] 分析失败原因
- [ ] 制定改进计划
- [ ] 更新文档

---

## 🎯 目标对标

### 行业标准

| 场景 | 推荐值 | 我们当前 | 改进空间 |
|------|--------|----------|---------|
| 电商平台 | 100-500 req/s | ~20 req/s | 5-25x |
| API 后端 | 50-200 req/s | ~20 req/s | 2.5-10x |
| SaaS 平台 | 100+ req/s | ~20 req/s | 5x+ |

### 我们的改进目标

```
当前:     ~20 req/s (成功率 8%)
第1周:    ~50 req/s (成功率 >80%)
第2周:   ~100 req/s (成功率 >95%)
目标:    >200 req/s (成功率 >99%)
```

---

## 📚 完整文档

- **完整性能报告**: `tests/PERFORMANCE_TEST_REPORT.md`
- **项目总结**: `PERFORMANCE_TESTING_SUMMARY.md`
- **测试脚本说明**: `tests/performance/README.md`

---

## ❓ 常见问题

### Q: 为什么成功率这么低?

A: 主要是 Prisma 查询错误和连接池不足。修复这两个问题后,成功率会显著提高。

### Q: 响应时间为什么这么快?

A: 5ms 的响应时间是正常的,因为是对 localhost 的测试。问题是成功率低,而不是响应速度慢。

### Q: 我应该从哪里开始优化?

A: 按优先级:
1. 修复 Prisma 错误
2. 增加连接池
3. 启用缓存
4. 添加索引

### Q: 需要多久才能看到改进?

A:
- 修复 Prisma 错误: 立即 (<1 分钟)
- 增加连接池: 立即 (<5 分钟)
- 启用缓存: 1-2 小时
- 完整优化: 1-2 天

---

## 📞 获得帮助

如有问题,请检查:

1. **后端日志**: 查看 `npm run dev` 的输出
2. **数据库日志**: 查看 PostgreSQL 日志
3. **完整文档**: 阅读 `PERFORMANCE_TEST_REPORT.md`

---

**最后更新**: 2025-10-17
**维护者**: Claude AI Performance Testing Team
