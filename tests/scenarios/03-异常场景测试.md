# 异常场景与边界测试

## 场景1: 网络异常场景

### 1.1 请求超时

**测试步骤**:
1. 模拟慢网络环境
2. 提交订单
3. 观察超时处理

**预期结果**:
- ✅ 显示加载状态
- ✅ 超时后显示错误提示
- ✅ 提供重试选项
- ✅ 不创建重复订单

### 1.2 网络中断

**测试步骤**:
1. 断开网络连接
2. 尝试访问页面

**预期结果**:
- ✅ 显示友好的离线提示
- ✅ 提供刷新页面选项

### 1.3 API返回错误

**测试步骤**:
1. 模拟后端500错误
2. 执行任意操作

**预期结果**:
- ✅ 捕获错误
- ✅ 显示友好错误信息
- ✅ 不崩溃

---

## 场景2: 数据验证场景

### 2.1 无效邮箱格式

**测试数据**:
```
invalid-email
test@
@example.com
test@@example.com
test@.com
```

**预期结果**:
- ✅ 所有格式都被拒绝
- ✅ 显示"请输入有效的邮箱地址"

### 2.2 SQL注入尝试

**测试数据**:
```
' OR '1'='1
'; DROP TABLE orders; --
1' UNION SELECT * FROM admin_users--
```

**预期结果**:
- ✅ 输入被安全处理
- ✅ 不执行恶意SQL
- ✅ 返回空结果或错误

### 2.3 XSS攻击尝试

**测试数据**:
```html
<script>alert('XSS')</script>
<img src=x onerror=alert('XSS')>
<iframe src="javascript:alert('XSS')">
```

**预期结果**:
- ✅ 脚本不执行
- ✅ HTML被转义显示
- ✅ 数据安全存储

### 2.4 超长输入

**测试数据**:
- 10000字符的产品描述
- 1000字符的邮箱地址
- 超大数量的购买数量(999999)

**预期结果**:
- ✅ 超长输入被拒绝
- ✅ 显示字符限制提示
- ✅ 数据库不溢出

### 2.5 特殊字符

**测试数据**:
```
产品名: emoji 🎉🎊🎈
邮箱: user+tag@example.com
密钥: XXXXX—XXXXX（全角）
```

**预期结果**:
- ✅ 正确处理特殊字符
- ✅ Unicode字符正常保存
- ✅ 显示不乱码

---

## 场景3: 并发场景

### 3.1 并发购买同一产品

**测试步骤**:
1. 同时开启10个浏览器标签页
2. 同时购买同一产品(仅剩5个库存)
3. 观察结果

**预期结果**:
- ✅ 只有5个订单成功
- ✅ 其余5个订单失败并提示库存不足
- ✅ 库存准确,不超卖

### 3.2 并发修改同一订单

**测试步骤**:
1. 两个管理员同时编辑同一订单
2. 几乎同时保存

**预期结果**:
- ✅ 使用乐观锁或悲观锁
- ✅ 后保存的数据生效
- ✅ 或提示"数据已被修改"

### 3.3 并发导入密钥

**测试步骤**:
1. 两个管理员同时导入相同密钥
2. 观察去重处理

**预期结果**:
- ✅ 重复密钥只导入一次
- ✅ 返回准确的导入统计

---

## 场景4: 边界值测试

### 4.1 最小购买数量

**测试步骤**:
1. 尝试购买0个产品
2. 尝试购买-1个产品

**预期结果**:
- ✅ 拒绝无效数量
- ✅ 显示"数量必须大于0"

### 4.2 最大购买数量

**测试步骤**:
1. 尝试购买超过库存的数量
2. 尝试购买极大数量(99999)

**预期结果**:
- ✅ 限制在库存范围内
- ✅ 提示库存不足

### 4.3 价格边界

**测试数据**:
```
价格: 0
价格: 0.01
价格: 99999999
价格: -100
```

**预期结果**:
- ✅ 0和负数被拒绝
- ✅ 0.01最小单位正常
- ✅ 超大金额有上限

### 4.4 时间边界

**测试步骤**:
1. 订单恰好在30分钟整时过期
2. 验证码恰好在5分钟整时过期

**预期结果**:
- ✅ 过期时间判断准确
- ✅ 边界情况处理正确

---

## 场景5: 权限与安全场景

### 5.1 未授权访问

**测试步骤**:
1. 不登录直接访问 `/admin/products`
2. 使用过期token访问
3. 使用伪造token访问

**预期结果**:
- ✅ 全部跳转到登录页
- ✅ 返回401未授权
- ✅ token验证严格

### 5.2 越权操作

**测试步骤**:
1. 普通管理员尝试删除产品(需要super_admin)
2. 普通用户尝试访问管理接口

**预期结果**:
- ✅ 返回403禁止访问
- ✅ 操作被阻止
- ✅ 记录安全日志

### 5.3 CSRF攻击

**测试步骤**:
1. 从外部网站提交表单到订单API
2. 不带CSRF token

**预期结果**:
- ✅ 请求被拒绝
- ✅ 需要有效token

### 5.4 暴力破解

**测试步骤**:
1. 连续输入100次错误密码
2. 短时间内大量请求

**预期结果**:
- ✅ 账号临时锁定
- ✅ 触发限流机制
- ✅ 记录异常登录

---

## 场景6: 数据一致性场景

### 6.1 事务回滚

**测试步骤**:
1. 创建订单过程中数据库连接中断
2. 密钥分配过程中发生错误

**预期结果**:
- ✅ 事务完整回滚
- ✅ 数据保持一致
- ✅ 库存不错乱

### 6.2 级联删除

**测试步骤**:
1. 删除有密钥的产品
2. 删除有订单项的订单

**预期结果**:
- ✅ 关联数据正确处理
- ✅ 外键约束生效
- ✅ 数据完整性保持

### 6.3 缓存一致性

**测试步骤**:
1. 修改产品信息
2. 立即查询产品

**预期结果**:
- ✅ 显示最新数据
- ✅ 缓存及时更新
- ✅ 无脏数据

---

## 场景7: 支付异常场景

### 7.1 重复支付回调

**测试步骤**:
1. 同一订单收到2次支付回调
2. 验证幂等性

**预期结果**:
- ✅ 订单只完成一次
- ✅ 密钥只分配一次
- ✅ 金额只记录一次

### 7.2 异常支付金额

**测试步骤**:
1. 支付回调金额与订单金额不符
2. 处理异常

**预期结果**:
- ✅ 拒绝处理
- ✅ 标记为异常订单
- ✅ 发送告警通知

### 7.3 支付超时

**测试步骤**:
1. 订单已过期后收到支付回调

**预期结果**:
- ✅ 拒绝支付
- ✅ 或创建新订单
- ✅ 通知用户处理

---

## 场景8: 邮件异常场景

### 8.1 邮件服务不可用

**测试步骤**:
1. 停止邮件服务
2. 创建订单

**预期结果**:
- ✅ 订单创建成功
- ✅ 记录邮件发送失败
- ✅ 后续重试发送

### 8.2 无效邮箱地址

**测试步骤**:
1. 使用不存在的邮箱下单
2. 发送邮件

**预期结果**:
- ✅ 记录退信
- ✅ 标记邮箱无效
- ✅ 不影响订单

---

## 场景9: 浏览器兼容性

### 测试浏览器
- Chrome (最新版)
- Firefox (最新版)
- Safari (最新版)
- Edge (最新版)
- 移动端浏览器

### 测试要点
- ✅ 页面正常渲染
- ✅ 交互功能正常
- ✅ 样式显示一致
- ✅ JavaScript无错误

---

## 场景10: 性能压力测试

### 10.1 高并发订单

**测试参数**:
- 并发用户: 100
- 请求总数: 1000
- 持续时间: 60秒

**性能指标**:
- ✅ 平均响应时间 < 500ms
- ✅ 95%请求 < 1000ms
- ✅ 错误率 < 1%
- ✅ 吞吐量 > 50 req/s

### 10.2 大数据量查询

**测试数据**:
- 订单数: 10000+
- 密钥数: 100000+
- 产品数: 1000+

**性能指标**:
- ✅ 列表加载 < 2秒
- ✅ 搜索响应 < 1秒
- ✅ 分页切换 < 500ms

---

## 测试工具推荐

### 自动化测试
- Playwright - E2E测试
- Jest - 单元测试
- Supertest - API测试

### 性能测试
- Apache JMeter
- Artillery
- k6

### 安全测试
- OWASP ZAP
- Burp Suite
- SQLMap

---

## 测试报告模板

```markdown
## 测试执行报告

**测试日期**: 2025-10-16
**测试人员**: XXX
**测试环境**: 开发环境

### 测试统计
- 总测试用例数: 50
- 通过: 48
- 失败: 2
- 阻塞: 0
- 通过率: 96%

### 失败用例
1. [BUG-001] 并发购买超卖问题
2. [BUG-002] 邮件发送失败未重试

### 风险评估
- 高风险: 0
- 中风险: 2
- 低风险: 0

### 建议
1. 修复并发库存问题
2. 实现邮件队列重试机制
3. 增加监控告警
```

---

## 持续测试计划

### 每次发布前
- [ ] 回归测试所有核心功能
- [ ] 执行安全测试
- [ ] 性能基准测试

### 每周
- [ ] 边界值测试
- [ ] 异常场景测试

### 每月
- [ ] 全面压力测试
- [ ] 安全渗透测试
- [ ] 兼容性测试
