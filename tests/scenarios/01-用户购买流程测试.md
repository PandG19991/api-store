# 用户购买流程测试场景

## 场景1: 成功购买单个产品

### 前置条件
- 产品有足够库存(至少1个可用密钥)
- 支付系统正常运行
- 邮件服务正常运行

### 测试步骤

1. **浏览产品列表**
   - 访问首页 `/`
   - 验证显示所有可用产品
   - 验证产品价格、描述正确显示

2. **查看产品详情**
   - 点击"Windows 11 Pro"产品
   - 验证产品详情页面加载
   - 验证产品描述、价格、库存状态显示

3. **添加到购物车**
   - 点击"立即购买"按钮
   - 验证跳转到结算页面

4. **填写订单信息**
   - 输入邮箱: `test@example.com`
   - 选择支付方式: 支付宝
   - 验证订单金额正确

5. **提交订单**
   - 点击"提交订单"按钮
   - 验证订单创建成功
   - 验证获得订单号 (格式: ORD开头的17位数字)

6. **模拟支付回调**
   - 调用支付回调API
   - 验证订单状态更新为"已完成"
   - 验证密钥已分配

7. **查询订单**
   - 访问订单查询页面 `/orders`
   - 输入邮箱获取验证码
   - 输入验证码查看订单
   - 验证订单详情显示
   - 验证密钥正确显示

### 预期结果
- ✅ 订单成功创建
- ✅ 支付回调处理正确
- ✅ 密钥自动分配
- ✅ 用户可查询和查看订单
- ✅ 密钥可复制使用

---

## 场景2: 购买多个产品

### 测试步骤

1. **添加多个产品到购物车**
   - 选择"Office 2021" x2
   - 选择"Adobe CC" x1
   - 验证购物车数量和总金额

2. **结算订单**
   - 填写邮箱
   - 选择支付方式
   - 提交订单

3. **验证密钥分配**
   - 验证3个密钥被正确分配
   - 验证每个产品对应正确的密钥

### 预期结果
- ✅ 多个产品订单创建成功
- ✅ 多个密钥正确分配
- ✅ 库存正确扣减

---

## 场景3: 库存不足场景

### 测试步骤

1. **购买库存不足的产品**
   - 选择某个库存为0的产品
   - 尝试购买

### 预期结果
- ✅ 显示"库存不足"错误
- ✅ 无法创建订单
- ✅ 给出友好的错误提示

---

## 场景4: 订单超时场景

### 测试步骤

1. **创建订单但不支付**
   - 创建订单
   - 等待超过30分钟

2. **检查订单状态**
   - 访问订单查询
   - 查看订单状态

### 预期结果
- ✅ 订单状态更新为"已过期"
- ✅ 密钥未被分配
- ✅ 库存未被扣减

---

## 场景5: 重复订单场景

### 测试步骤

1. **同一邮箱短时间内多次购买**
   - 使用同一邮箱创建第1个订单
   - 立即使用同一邮箱创建第2个订单

### 预期结果
- ✅ 两个订单都能成功创建
- ✅ 订单号不同
- ✅ 密钥不重复

---

## 测试数据

```javascript
// 测试用户邮箱
const testEmails = [
  'user1@test.com',
  'user2@test.com',
  'admin@test.com'
]

// 测试产品
const testProducts = [
  { id: 1, name: 'Windows 11 Pro', price: 299 },
  { id: 2, name: 'Office 2021', price: 199 },
  { id: 3, name: 'Adobe CC', price: 599 }
]

// 测试支付方式
const paymentMethods = ['alipay', 'wechat']
```

---

## 验证要点

### 数据验证
- 订单号格式正确
- 金额计算准确
- 密钥格式符合规范
- 时间戳记录准确

### 状态验证
- pending → paid → completed 状态流转正确
- 超时订单自动标记为expired
- 取消订单状态正确

### 库存验证
- 下单后库存正确扣减
- 订单取消后库存正确恢复
- 并发下单库存处理正确

### 邮件验证
- 订单确认邮件发送
- 密钥交付邮件发送
- 邮件内容正确包含订单信息

### 安全验证
- 验证码6位数字
- 验证码5分钟内有效
- 验证码一次性使用
- 敏感信息不泄露
